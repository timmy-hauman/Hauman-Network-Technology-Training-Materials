<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>網路架構教學：Loopback Interface 的基礎與應用</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Mermaid JS for diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        
        .section-card {
            background: white;
            border-radius: 0.75rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-left: 5px solid #3b82f6;
        }

        .concept-highlight {
            background-color: #eff6ff;
            border-left: 4px solid #2563eb;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 0.5rem 0.5rem 0;
        }

        .quiz-option {
            transition: all 0.2s;
            cursor: pointer;
        }
        .quiz-option:hover {
            background-color: #f3f4f6;
        }
        .quiz-correct {
            background-color: #d1fae5 !important;
            border-color: #10b981 !important;
            color: #065f46;
        }
        .quiz-wrong {
            background-color: #fee2e2 !important;
            border-color: #ef4444 !important;
            color: #991b1b;
        }
        
        /* Mermaid positioning */
        .mermaid {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="bg-slate-800 text-white p-6 shadow-lg">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold mb-2"><i class="fas fa-network-wired mr-2"></i>網路架構大師班</h1>
            <p class="text-slate-300">單元主題：Loopback Interface (迴路介面) 的基礎與應用</p>
            <div class="mt-4 flex items-center text-sm text-slate-400">
                <span class="bg-blue-600 text-white px-2 py-1 rounded text-xs mr-2">L3 Switching</span>
                <span class="bg-blue-600 text-white px-2 py-1 rounded text-xs mr-2">OSPF</span>
                <span class="bg-blue-600 text-white px-2 py-1 rounded text-xs">High Availability</span>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-6">

        <!-- Intro -->
        <div class="mb-8 text-gray-700">
            <p class="text-lg">
                各位同學好，我是你們的網路架構講師。今天我們要探討一個在 Layer 3 交換器 (L3 SW) 部署中至關重要的概念——<strong>Loopback Interface</strong>。
                在多重路徑的動態路由環境下，為什麼我們不直接 Ping 實體介面，而是要 Ping 一個虛擬的 Loopback IP？讓我們一起揭開它「永遠在線」的秘密。
            </p>
        </div>

        <!-- Section 1: Concept -->
        <div class="section-card">
            <h2 class="text-2xl font-bold text-slate-800 mb-4 border-b pb-2">一、核心概念 (Concept)</h2>
            
            <div class="mb-6">
                <h3 class="font-bold text-lg text-blue-700 mb-2">一句話定義</h3>
                <p class="text-gray-700 bg-gray-50 p-4 rounded-lg border border-gray-200">
                    Loopback Interface 是一個<strong>邏輯上的虛擬介面 (Logical Virtual Interface)</strong>，只要設備本身電源開啟且作業系統運作正常，這個介面就永遠處於 "UP" 狀態，不受任何實體線路斷線影響。
                </p>
            </div>

            <div>
                <h3 class="font-bold text-lg text-blue-700 mb-2">生活化比喻：手機號碼 vs. 座機分機</h3>
                <div class="concept-highlight">
                    <p class="mb-2"><strong>想像一下：</strong></p>
                    <ul class="list-disc list-inside space-y-2">
                        <li><strong>實體介面 IP (Physical Interface IP)</strong> 就像是辦公室桌上的<strong>「座機分機」</strong>。如果你換了座位（線路改變），或者電話線被老鼠咬斷（實體斷線），別人打這個分機就找不到你。</li>
                        <li><strong>Loopback IP</strong> 就像是你的<strong>「手機號碼」</strong>。無論你在辦公室的哪個角落，或是透過哪條走廊（路徑）移動，只要你這個人（Switch）還在，別人撥打你的手機號碼永遠都能找到你。</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Section 2: Mechanism -->
        <div class="section-card">
            <h2 class="text-2xl font-bold text-slate-800 mb-4 border-b pb-2">二、運作原理 (Mechanism)</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-bold text-lg text-blue-700 mb-2"><i class="fas fa-microchip mr-2"></i>技術細節</h3>
                    <ul class="list-disc list-inside space-y-2 text-gray-700">
                        <li><strong>獨立性：</strong>它不綁定任何 ASIC 晶片上的實體 Port，因此不會因為網路線鬆脫或光纖斷裂而變為 Down。</li>
                        <li><strong>路由通告 (Advertisement)：</strong>在 OSPF 或 BGP 等動態路由協定中，我們會將 Loopback IP 通告出去。由於 L3 Switch 通常有多條線路連接核心網路，只要<strong>任何一條</strong>實體線路活著，外部就能透過路由表學到「去往 Loopback IP」的路徑。</li>
                        <li><strong>Router ID：</strong>在 OSPF 中，通常選用 Loopback IP 作為 Router ID，因為它最穩定，不會因為介面翻動 (Flapping) 導致路由程序重啟。</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-blue-700 mb-2"><i class="fas fa-sliders-h mr-2"></i>關鍵參數</h3>
                    <div class="bg-slate-800 text-green-400 p-4 rounded text-sm font-mono">
                        <p class="mb-2 text-gray-400"># IP 設定標準</p>
                        <p>Mask: 255.255.255.255 (/32)</p>
                        <p class="mt-2 text-gray-400"># ExtremeXOS 範例</p>
                        <p>create vlan "loopback"</p>
                        <p>configure vlan "loopback" tag 4094</p>
                        <p>configure vlan "loopback" ipaddress 10.255.1.1/32</p>
                        <p>enable loopback-mode vlan "loopback"</p>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">*註：/32 遮罩表示該網段只有這一個 IP，節省位址並精確路由。</p>
                </div>
            </div>
        </div>

        <!-- Section 3: Visuals -->
        <div class="section-card">
            <h2 class="text-2xl font-bold text-slate-800 mb-4 border-b pb-2">三、架構視覺化 (Visuals)</h2>
            <p class="mb-4 text-gray-600">以下圖表展示了當實體線路發生故障時，Loopback IP 如何透過備援路徑保持連線。</p>

            <div class="mb-8">
                <h4 class="text-center font-bold text-gray-700 mb-2">圖表一：Loopback 介面在多路徑架構下的存活邏輯</h4>
                <div class="mermaid">
                    graph TD
                        Manager["網管人員/監控系統"]
                        
                        subgraph Core_Network ["核心網路"]
                            Core_A["核心交換器 A"]
                            Core_B["核心交換器 B"]
                        end
                        
                        subgraph Edge_L3_Switch ["邊緣 L3 Switch (目標設備)"]
                            direction TB
                            Port1["Port 1: 實體介面 <br/> (狀態: DOWN ❌)"]
                            Port2["Port 2: 實體介面 <br/> (狀態: UP ✅)"]
                            Loop0((("Loopback 0 <br/> 10.255.1.1/32 <br/> 狀態: Always UP")))
                        end

                        Manager -- "PING 10.255.1.1" --> Core_A
                        Manager -- "PING 10.255.1.1" --> Core_B
                        
                        Core_A -. "OSPF 路徑 (斷線)" .-> Port1
                        Core_B == "OSPF 路徑 (正常)" ==> Port2
                        
                        Port2 -. "內部轉送" .-> Loop0
                        
                        style Loop0 fill:#f96,stroke:#333,stroke-width:2px,color:white
                        style Port1 fill:#ffcccc,stroke:#f00
                        style Port2 fill:#ccffcc,stroke:#0f0
                </div>
                <p class="text-center text-sm text-gray-500">說明：即便 Port 1 斷線，管理者只要 Ping Loopback IP，封包會自動由 OSPF 導向 Port 2 進入設備。</p>
            </div>

            <hr class="my-6 border-gray-200">

            <div>
                <h4 class="text-center font-bold text-gray-700 mb-2">圖表二：封包處理流程 (Sequence Diagram)</h4>
                <div class="mermaid">
                    sequenceDiagram
                        participant User as "管理者 PC"
                        participant RoutingTable as "核心網路路由表"
                        participant TargetSW as "目標 Switch (L3)"
                        
                        Note over User, TargetSW: 情境：Port 1 斷線，Port 2 正常
                        
                        User->>RoutingTable: 請求連線至 Loopback IP (10.255.1.1)
                        RoutingTable->>RoutingTable: 查詢 OSPF 資料庫
                        RoutingTable-->>RoutingTable: 發現 Port 1 路徑失效，切換至 Port 2
                        RoutingTable->>TargetSW: 封包經由 Port 2 送達
                        TargetSW->>TargetSW: 檢查目的 IP
                        Note right of TargetSW: 目的 IP = Loopback IP (本機)<br/>允許進入 CPU 處理
                        TargetSW-->>User: 回傳 SSH/SNMP 回應
                </div>
            </div>
        </div>

        <!-- Section 4: Use Case -->
        <div class="section-card">
            <h2 class="text-2xl font-bold text-slate-800 mb-4 border-b pb-2">四、實務應用場景 (Use Case)</h2>
            
            <div class="bg-white rounded-lg">
                <h3 class="font-bold text-lg text-gray-800 mb-3">場景：大型園區網路的管理 IP (Management IP) 規劃</h3>
                
                <p class="text-gray-700 mb-4">
                    <strong>情境：</strong> 一家擁有 10 棟大樓的大型科技園區，每一棟大樓的匯聚交換器 (Aggregation Switch) 都透過兩條光纖連回核心機房 (雙上聯架構)。
                </p>
                <p class="text-gray-700 mb-4">
                    <strong>挑戰：</strong> 網管人員需要每天備份設定檔並監控設備。如果使用實體介面 VLAN IP (例如 VLAN 10 on Port 1) 作為管理 IP，當光纖 A 斷線時，雖然光纖 B 透過 STP/OSPF 接手了流量，但網管人員卻 Ping 不到那個綁定在光纖 A 路徑上的 IP，誤以為設備當機。
                </p>
                <p class="text-gray-700 mb-4">
                    <strong>解決方案：</strong> 為每一台匯聚交換器設定一個 <strong>Loopback IP (例如 192.168.255.x/32)</strong>，並透過 OSPF 將此網段發布到核心。
                </p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div class="bg-green-50 p-4 rounded border border-green-200">
                        <h4 class="font-bold text-green-800 mb-2"><i class="fas fa-thumbs-up mr-2"></i>優點 (Pros)</h4>
                        <ul class="list-disc list-inside text-sm text-gray-700">
                            <li><strong>高可用性：</strong>只要設備還有一口氣（任一線路連線中），管理 IP 就通。</li>
                            <li><strong>易於記憶：</strong>可以有系統地規劃（如 Building 1 = .1, Building 2 = .2），不需記憶複雜的實體介面 IP。</li>
                            <li><strong>穩定路由：</strong>作為 OSPF Router ID，避免因介面 Up/Down 造成 OSPF 程序震盪。</li>
                            <li><strong>便於測試：</strong>Ping Loopback IP 可直接驗證「到達該設備的路由」是否健康，而非單純測試線路。</li>
                        </ul>
                    </div>
                    <div class="bg-red-50 p-4 rounded border border-red-200">
                        <h4 class="font-bold text-red-800 mb-2"><i class="fas fa-thumbs-down mr-2"></i>缺點/限制 (Cons)</h4>
                        <ul class="list-disc list-inside text-sm text-gray-700">
                            <li><strong>需要路由支援：</strong>必須搭配靜態路由或動態路由 (OSPF/EIGRP/BGP) 才能讓其他設備連得到這個「虛擬」IP。</li>
                            <li><strong>位址規劃：</strong>需要額外規劃一個獨立的網段給 Loopback 使用，雖然消耗不多 (/32)，但仍需管理。</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 5: Quiz -->
        <div class="section-card">
            <h2 class="text-2xl font-bold text-slate-800 mb-4 border-b pb-2">五、隨堂測驗 (Quiz)</h2>
            <p class="mb-4 text-gray-600">請嘗試回答下列問題，驗證您對 Loopback Interface 的理解。</p>

            <div id="quiz-container" class="space-y-6">
                <!-- Questions will be injected here by JS -->
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-slate-800 text-slate-400 py-4 mt-8">
        <div class="max-w-4xl mx-auto text-center text-sm font-mono">
            Planning & Design by Timmy(timmyc@hauman.com.tw) | 豪勉科技 Hauman Technologies Corporation | Ver 1.0
        </div>
    </footer>

    <script>
        // Initialize Mermaid
        mermaid.initialize({ startOnLoad: true, theme: 'neutral' });

        // Quiz Data
        const quizData = [
            {
                id: 1,
                question: "當 L3 Switch 的 Port 1 發生斷線 (Link Down) 時，該設備上的 Loopback Interface 狀態會如何？",
                options: [
                    "會跟著變為 Down",
                    "會進入 Error-Disable 狀態",
                    "保持 UP 狀態，不受實體介面影響",
                    "會重啟 OSPF 程序"
                ],
                answer: 2, // 0-indexed
                explanation: "Loopback 是虛擬介面，只要設備作業系統運作正常，它永遠保持 UP，不依賴單一實體線路。"
            },
            {
                id: 2,
                question: "在設定 Loopback Interface IP 時，最推薦使用的子網路遮罩 (Subnet Mask) 是多少？",
                options: [
                    "255.255.255.0 (/24)",
                    "255.255.0.0 (/16)",
                    "255.255.255.255 (/32)",
                    "255.255.255.252 (/30)"
                ],
                answer: 2,
                explanation: "Loopback 通常代表單一設備節點，使用 /32 (255.255.255.255) 最節省 IP 位址且路由最精確。"
            },
            {
                id: 3,
                question: "在 OSPF 動態路由協定中，使用 Loopback IP 作為 Router ID 的主要好處是什麼？",
                options: [
                    "提高資料傳輸頻寬",
                    "避免因實體介面不穩定導致 Router ID 改變而造成路由震盪",
                    "可以省略密碼驗證步驟",
                    "讓封包延遲降低"
                ],
                answer: 1,
                explanation: "Router ID 若綁定在實體介面，該介面斷線會導致 OSPF 重新選舉，造成網路震盪。Loopback 穩定不變，是最佳選擇。"
            },
            {
                id: 4,
                question: "在 ExtremeXOS 中，若要啟用 Loopback 功能，除了設定 VLAN IP 外，通常還需要哪個關鍵指令？",
                options: [
                    "enable ip-forwarding",
                    "enable loopback-mode vlan [name]",
                    "configure vlan default delete ports all",
                    "disable spanning-tree"
                ],
                answer: 1,
                explanation: "在 ExtremeXOS 中，雖然可以建立 VLAN，但明確啟用 `enable loopback-mode` 可以讓該 VLAN 的行為更符合 Loopback 介面的特性（如不參與 STP、永遠 UP）。"
            },
            {
                id: 5,
                question: "為什麼網管人員喜歡用 Loopback IP 進行 SSH 遠端管理？",
                options: [
                    "因為它不需要輸入帳號密碼",
                    "因為它的 IP 比較短",
                    "因為具備多路徑備援特性，只要有任一路徑可達，就能連線管理",
                    "因為 Loopback IP 速度比實體 IP 快"
                ],
                answer: 2,
                explanation: "這是 Loopback 最大的管理優勢。只要網路中還有任何一條路徑通往該設備，Loopback IP 就可達，確保管理不中斷。"
            }
        ];

        // Render Quiz
        const quizContainer = document.getElementById('quiz-container');

        quizData.forEach((item, index) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'bg-white p-4 rounded border border-gray-200 shadow-sm';
            
            let optionsHtml = '';
            item.options.forEach((opt, optIndex) => {
                optionsHtml += `
                    <div class="quiz-option p-3 rounded border border-gray-200 mb-2" 
                         onclick="checkAnswer(${index}, ${optIndex}, this)">
                        <span class="font-bold mr-2">${String.fromCharCode(65 + optIndex)}.</span> ${opt}
                    </div>
                `;
            });

            questionDiv.innerHTML = `
                <h3 class="font-bold text-lg mb-3 text-slate-700">Q${index + 1}. ${item.question}</h3>
                <div class="options-container" id="q${index}-options">
                    ${optionsHtml}
                </div>
                <div id="q${index}-feedback" class="hidden mt-3 p-3 rounded text-sm"></div>
            `;
            quizContainer.appendChild(questionDiv);
        });

        // Quiz Logic
        function checkAnswer(questionIndex, selectedOptionIndex, element) {
            const currentQuestion = quizData[questionIndex];
            const optionsContainer = document.getElementById(`q${questionIndex}-options`);
            const feedbackDiv = document.getElementById(`q${questionIndex}-feedback`);
            
            // Disable further clicks for this question
            const allOptions = optionsContainer.children;
            for (let i = 0; i < allOptions.length; i++) {
                allOptions[i].onclick = null;
                allOptions[i].style.cursor = 'default';
            }

            if (selectedOptionIndex === currentQuestion.answer) {
                // Correct
                element.classList.add('quiz-correct');
                feedbackDiv.classList.remove('hidden');
                feedbackDiv.classList.add('bg-green-100', 'text-green-800');
                feedbackDiv.innerHTML = `<strong><i class="fas fa-check-circle"></i> 正確！</strong> ${currentQuestion.explanation}`;
            } else {
                // Wrong
                element.classList.add('quiz-wrong');
                // Highlight correct answer
                allOptions[currentQuestion.answer].classList.add('quiz-correct');
                
                feedbackDiv.classList.remove('hidden');
                feedbackDiv.classList.add('bg-red-100', 'text-red-800');
                feedbackDiv.innerHTML = `<strong><i class="fas fa-times-circle"></i> 錯誤。</strong> 正確答案是 ${String.fromCharCode(65 + currentQuestion.answer)}。<br>${currentQuestion.explanation}`;
            }
        }
    </script>
</body>
</html>