<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VLAN Tagging & Untagging 互動教學</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8;
        }

        .device-box {
            transition: all 0.3s ease;
        }

        .port {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            border: 2px solid #cbd5e1;
            background-color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            color: #64748b;
            position: relative;
            z-index: 10;
        }

        .port.active {
            border-color: #22c55e;
            background-color: #dcfce7;
            color: #15803d;
        }

        /* Packet Styles */
        .packet {
            height: 36px;
            background-color: #e2e8f0;
            border: 2px solid #64748b;
            border-radius: 8px;
            position: absolute;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: #334155;
            transition: top 0.8s ease-in-out, left 0.8s ease-in-out, width 0.3s ease, border-color 0.3s ease;
            opacity: 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
            overflow: hidden;
            padding: 0 8px; /* Increased padding slightly */
            min-width: 100px; /* Ensure a minimum width */
        }

        .packet.tagged {
            border-color: #0f172a;
            background-color: #fff;
        }

        /* Connection Lines (SVG) */
        svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .cable {
            stroke: #94a3b8;
            stroke-width: 3;
            fill: none;
        }
        
        .cable.trunk {
            stroke: #475569;
            stroke-width: 5;
        }

        .console-text {
            font-family: 'Courier New', Courier, monospace;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- Header -->
    <header class="text-center mb-6 max-w-4xl w-full">
        <h1 class="text-3xl font-bold text-slate-800 mb-2">VLAN Tag & Untag 互動實驗室</h1>
        <p class="text-slate-600">
            觀察乙太網路幀 (Frame) 如何在 Access(Untag) Port 與 Trunk(Tag) Port 之間轉換。<br>
            <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">VLAN 10: 銷售部 (藍色)</span>
            <span class="text-sm bg-orange-100 text-orange-800 px-2 py-1 rounded ml-2">VLAN 20: 工程部 (橘色)</span>
        </p>
    </header>

    <!-- Main Interactive Area -->
    <main class="relative bg-white rounded-xl shadow-xl w-full max-w-5xl h-[500px] border border-slate-200 overflow-hidden mb-6" id="network-canvas">
        
        <!-- SVG Layer for Cables -->
        <svg id="cables-layer">
            <!-- Cables will be drawn by JS -->
        </svg>

        <!-- Components Grid -->
        <div class="absolute inset-0 grid grid-cols-4 gap-2 p-8 pointer-events-none">
            
            <!-- Column 1: Source Devices (PC1, PC3) -->
            <div class="flex flex-col justify-between items-center pointer-events-auto">
                <div id="pc1" class="device-box bg-blue-50 border-2 border-blue-200 p-3 rounded-lg text-center w-32 relative">
                    <i class="fas fa-desktop text-2xl text-blue-500 mb-1"></i>
                    <div class="font-bold text-slate-700">PC 1</div>
                    <div class="text-xs text-slate-500">192.168.10.1</div>
                    <div class="text-xs font-bold text-blue-600">VLAN 10</div>
                    <div class="port absolute -right-3 top-1/2 -translate-y-1/2 bg-white" id="port-pc1">NIC</div>
                </div>

                <div id="pc3" class="device-box bg-orange-50 border-2 border-orange-200 p-3 rounded-lg text-center w-32 relative">
                    <i class="fas fa-laptop text-2xl text-orange-500 mb-1"></i>
                    <div class="font-bold text-slate-700">PC 3</div>
                    <div class="text-xs text-slate-500">192.168.20.1</div>
                    <div class="text-xs font-bold text-orange-600">VLAN 20</div>
                    <div class="port absolute -right-3 top-1/2 -translate-y-1/2 bg-white" id="port-pc3">NIC</div>
                </div>
            </div>

            <!-- Column 2: Switch A (Light theme) -->
            <div class="flex flex-col justify-center items-center pointer-events-auto">
                <!-- Increased width to w-52 to fit new labels -->
                <div id="sw1" class="device-box bg-slate-50 text-slate-800 border-2 border-slate-300 p-4 rounded shadow-lg w-52 relative z-20">
                    <div class="text-center font-bold border-b border-slate-300 pb-2 mb-4 text-slate-700">Switch A</div>
                    
                    <!-- Ports on LEFT -->
                    <div class="flex justify-start items-center gap-3 mb-4 px-2">
                        <div class="port" id="port-sw1-access10">1</div>
                        <span class="text-[10px] text-slate-500 font-semibold">Access(Untag) V10</span>
                    </div>
                    
                    <div class="flex justify-start items-center gap-3 mb-4 px-2">
                        <div class="port" id="port-sw1-access20">2</div>
                        <span class="text-[10px] text-slate-500 font-semibold">Access(Untag) V20</span>
                    </div>

                    <!-- Trunk Port aligned to bottom-right -->
                    <div class="flex justify-end items-center mt-8 pt-2 border-t border-slate-300 px-2">
                        <span class="text-[10px] text-yellow-600 mr-2 font-bold">Trunk(Tag) Port</span>
                        <div class="port border-yellow-400 text-yellow-600 bg-yellow-50" id="port-sw1-trunk">T1</div>
                    </div>
                </div>
            </div>

            <!-- Column 3: Switch B (Light theme) -->
            <div class="flex flex-col justify-center items-center pointer-events-auto">
                <!-- Increased width to w-52 to fit new labels -->
                <div id="sw2" class="device-box bg-slate-50 text-slate-800 border-2 border-slate-300 p-4 rounded shadow-lg w-52 z-20">
                    <div class="text-center font-bold border-b border-slate-300 pb-2 mb-4 text-slate-700">Switch B</div>
                    
                    <!-- Ports on RIGHT -->
                    <div class="flex justify-end items-center gap-3 mb-4 px-2">
                        <span class="text-[10px] text-slate-500 font-semibold">Access(Untag) V10</span>
                        <div class="port" id="port-sw2-access10">1</div>
                    </div>
                    
                    <div class="flex justify-end items-center gap-3 mb-4 px-2">
                        <span class="text-[10px] text-slate-500 font-semibold">Access(Untag) V20</span>
                        <div class="port" id="port-sw2-access20">2</div>
                    </div>
                    
                    <!-- Trunk Port aligned to bottom-left -->
                    <div class="flex justify-start items-center mt-8 pt-2 border-t border-slate-300 px-2">
                        <div class="port border-yellow-400 text-yellow-600 bg-yellow-50" id="port-sw2-trunk">T1</div>
                        <span class="text-[10px] text-yellow-600 ml-2 font-bold">Trunk(Tag) Port</span>
                    </div>
                </div>
            </div>

            <!-- Column 4: Destination Devices (PC2, PC4) -->
            <div class="flex flex-col justify-between items-center pointer-events-auto">
                <div id="pc2" class="device-box bg-blue-50 border-2 border-blue-200 p-3 rounded-lg text-center w-32 relative">
                    <div class="port absolute -left-3 top-1/2 -translate-y-1/2 bg-white" id="port-pc2">NIC</div>
                    <i class="fas fa-desktop text-2xl text-blue-500 mb-1"></i>
                    <div class="font-bold text-slate-700">PC 2</div>
                    <div class="text-xs text-slate-500">192.168.10.2</div>
                    <div class="text-xs font-bold text-blue-600">VLAN 10</div>
                </div>

                <div id="pc4" class="device-box bg-orange-50 border-2 border-orange-200 p-3 rounded-lg text-center w-32 relative">
                    <div class="port absolute -left-3 top-1/2 -translate-y-1/2 bg-white" id="port-pc4">NIC</div>
                    <i class="fas fa-laptop text-2xl text-orange-500 mb-1"></i>
                    <div class="font-bold text-slate-700">PC 4</div>
                    <div class="text-xs text-slate-500">192.168.20.2</div>
                    <div class="text-xs font-bold text-orange-600">VLAN 20</div>
                </div>
            </div>
        </div>

        <!-- The Packet -->
        <div id="packet" class="packet hidden">
            <!-- Content injected by JS -->
        </div>

        <!-- Packet Inspector Panel (New) -->
        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-white/95 backdrop-blur-sm p-3 rounded-lg shadow-xl border border-slate-300 text-sm z-40 transition-all duration-300 min-w-[300px]">
            <div class="flex justify-between items-center border-b border-slate-200 pb-2 mb-2">
                <div class="font-bold text-slate-700"><i class="fas fa-microscope mr-2 text-blue-500"></i>封包結構透視</div>
                <div id="inspector-status-text" class="text-xs font-bold text-slate-500">等待中...</div>
            </div>
            
            <!-- Packet Structure Visualization -->
            <div class="flex items-center justify-center space-x-1">
                <div class="bg-slate-100 border border-slate-300 text-slate-500 px-3 py-2 rounded text-xs font-mono text-center">
                    <div class="text-[9px] uppercase mb-1">Header</div>
                    MAC
                </div>
                
                <!-- The Dynamic Tag Field (Initially Hidden) -->
                <div id="inspector-tag-field" class="hidden transition-all duration-300 px-3 py-2 rounded text-xs font-mono text-center border font-bold shadow-sm">
                    <!-- Content injected by JS -->
                </div>

                <div class="bg-slate-100 border border-slate-300 text-slate-500 px-3 py-2 rounded text-xs font-mono text-center flex-1">
                    <div class="text-[9px] uppercase mb-1">Payload</div>
                    DATA
                </div>
            </div>
        </div>

        <!-- Labels for Links -->
        <div class="absolute text-xs text-slate-400 font-bold" style="left: 22%; top: 25%; transform: translateX(-50%);">Access Link</div>
        <div class="absolute text-xs text-slate-500 font-bold bg-white px-2 py-1 rounded border border-slate-300 shadow-sm z-30" style="left: 50%; top: 72%; transform: translateX(-50%);">802.1Q Trunk Link</div>
        <div class="absolute text-xs text-slate-400 font-bold" style="left: 78%; top: 25%; transform: translateX(-50%);">Access Link</div>

    </main>

    <!-- Controls & Info Panel -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-5xl">
        
        <!-- Controls -->
        <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-blue-500">
            <h2 class="text-lg font-bold mb-4 flex items-center"><i class="fas fa-gamepad mr-2"></i> 控制台</h2>
            <div class="space-y-3">
                <button onclick="startSimulation(10)" id="btn-v10" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded transition flex items-center justify-center">
                    <i class="fas fa-paper-plane mr-2"></i> 發送 VLAN 10 封包
                </button>
                <button onclick="startSimulation(20)" id="btn-v20" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded transition flex items-center justify-center">
                    <i class="fas fa-paper-plane mr-2"></i> 發送 VLAN 20 封包
                </button>
            </div>
            <div class="mt-4 p-3 bg-yellow-50 text-yellow-800 text-sm rounded border border-yellow-200">
                <i class="fas fa-info-circle mr-1"></i> 
                請觀察上方「封包結構透視」面板中 VLAN Tag 欄位的變化。
            </div>
        </div>

        <!-- Status/Log -->
        <div class="md:col-span-2 bg-slate-900 text-green-400 p-6 rounded-lg shadow-md font-mono text-sm overflow-hidden flex flex-col relative">
            <div class="absolute top-2 right-3 text-xs text-slate-500">SYSTEM LOG</div>
            <div id="status-display" class="flex-1 space-y-2 mt-2">
                <p>> 等待指令...</p>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <footer class="mt-12 mb-6 text-center text-slate-400 text-xs w-full max-w-5xl border-t border-slate-200 pt-4">
        <p>Planning & Design by Timmy(timmyc@hauman.com.tw) | 豪勉科技 Hauman Technologies Corporation | Ver 1.0</p>
    </footer>

    <script>
        // Configuration
        const config = {
            10: {
                color: '#3b82f6', // Blue
                tagColor: '#2563eb',
                tagBg: '#dbeafe',
                tagText: '#1e40af',
                sourceId: 'port-pc1',
                sw1Ingress: 'port-sw1-access10',
                sw1Egress: 'port-sw1-trunk',
                sw2Ingress: 'port-sw2-trunk',
                sw2Egress: 'port-sw2-access10',
                destId: 'port-pc2'
            },
            20: {
                color: '#f97316', // Orange
                tagColor: '#ea580c',
                tagBg: '#ffedd5',
                tagText: '#9a3412',
                sourceId: 'port-pc3',
                sw1Ingress: 'port-sw1-access20',
                sw1Egress: 'port-sw1-trunk',
                sw2Ingress: 'port-sw2-trunk',
                sw2Egress: 'port-sw2-access20',
                destId: 'port-pc4'
            }
        };

        let isAnimating = false;

        // Draw cables on load and resize
        window.addEventListener('load', drawCables);
        window.addEventListener('resize', drawCables);

        function getCenter(elementId) {
            const el = document.getElementById(elementId);
            if (!el) return {x:0, y:0};
            const rect = el.getBoundingClientRect();
            const container = document.getElementById('network-canvas').getBoundingClientRect();
            return {
                x: rect.left + rect.width / 2 - container.left,
                y: rect.top + rect.height / 2 - container.top
            };
        }

        function drawLine(svg, id1, id2, isTrunk = false) {
            const p1 = getCenter(id1);
            const p2 = getCenter(id2);
            
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', p1.x);
            line.setAttribute('y1', p1.y);
            line.setAttribute('x2', p2.x);
            line.setAttribute('y2', p2.y);
            line.setAttribute('class', isTrunk ? 'cable trunk' : 'cable');
            svg.appendChild(line);
        }

        function drawCables() {
            const svg = document.getElementById('cables-layer');
            svg.innerHTML = ''; // Clear existing
            
            // Vlan 10 Path
            drawLine(svg, 'port-pc1', 'port-sw1-access10');
            drawLine(svg, 'port-sw2-access10', 'port-pc2');
            
            // Vlan 20 Path
            drawLine(svg, 'port-pc3', 'port-sw1-access20');
            drawLine(svg, 'port-sw2-access20', 'port-pc4');

            // Trunk Path
            drawLine(svg, 'port-sw1-trunk', 'port-sw2-trunk', true);
        }

        // Logging Helper
        function log(message, type = 'info') {
            const display = document.getElementById('status-display');
            const p = document.createElement('p');
            p.className = 'console-text border-l-2 pl-2 animate-[pulse_0.5s]';
            
            if(type === 'info') p.className += ' border-green-500 text-green-400';
            if(type === 'action') p.className += ' border-yellow-500 text-yellow-300 font-bold';
            if(type === 'success') p.className += ' border-blue-500 text-white';

            p.innerHTML = `<span class="opacity-50">${new Date().toLocaleTimeString().split(' ')[0]}</span> ${message}`;
            display.innerHTML = ''; 
            display.appendChild(p);
        }

        function appendLog(message, type = 'info') {
            const display = document.getElementById('status-display');
            const p = document.createElement('p');
            p.className = 'console-text border-l-2 pl-2';
             if(type === 'info') p.className += ' border-gray-600 text-gray-400';
             if(type === 'highlight') p.className += ' border-white text-white font-bold';
             if(type === 'tag') p.className += ' border-red-500 text-red-300';
            p.innerHTML = `> ${message}`;
            display.appendChild(p);
        }

        function updatePacketUI(state, vlanId) {
            const packet = document.getElementById('packet');
            const inspectorTag = document.getElementById('inspector-tag-field');
            const inspectorStatus = document.getElementById('inspector-status-text');

            if (state === 'tagged') {
                const conf = config[vlanId];
                packet.classList.add('tagged');
                
                // Update Packet Visual (On the wire) - Adjusted Text & Colors
                packet.innerHTML = `
                    <span class="text-xs mr-2 font-bold text-slate-700">Frame</span>
                    <div class="flex items-center justify-center px-2 py-0.5 rounded text-xs font-bold shadow-sm" style="background-color: ${conf.color}; color: white; border: 1px solid white;">
                        VID:${vlanId}
                    </div>
                `;
                packet.style.width = '130px'; 
                packet.style.borderColor = conf.tagColor;

                // Update Inspector Visual (Bottom Panel)
                inspectorTag.classList.remove('hidden');
                inspectorTag.style.backgroundColor = conf.tagBg;
                inspectorTag.style.color = conf.tagText;
                inspectorTag.style.borderColor = conf.tagColor;
                inspectorTag.innerHTML = `<div class="text-[9px] uppercase mb-1">802.1Q</div>VID: ${vlanId}`;
                
                inspectorStatus.textContent = "狀態: Tagged (VLAN ID 可見)";
                inspectorStatus.className = "text-xs font-bold text-red-500 animate-pulse";

            } else {
                packet.classList.remove('tagged');
                
                // Update Packet Visual (On the wire) - Fixed Contrast Issue
                packet.innerHTML = `
                    <span class="text-xs mr-1 font-bold text-slate-700">Standard</span>
                    <span class="text-xs font-bold text-slate-500">Frame</span>
                `;
                packet.style.width = '110px'; 
                packet.style.borderColor = '#64748b';

                // Update Inspector Visual (Bottom Panel)
                inspectorTag.classList.add('hidden');

                inspectorStatus.textContent = "狀態: Untagged (無 VLAN ID)";
                inspectorStatus.className = "text-xs font-bold text-slate-500";
            }
        }

        function movePacket(elementId) {
            return new Promise(resolve => {
                const packet = document.getElementById('packet');
                const target = getCenter(elementId);
                
                packet.style.left = target.x + 'px';
                packet.style.top = target.y + 'px';

                const port = document.getElementById(elementId);
                if(port) port.classList.add('active');

                setTimeout(() => {
                    if(port) port.classList.remove('active');
                    resolve();
                }, 1500); 
            });
        }

        async function startSimulation(vlanId) {
            if (isAnimating) return;
            isAnimating = true;

            const cfg = config[vlanId];
            const packet = document.getElementById('packet');
            const btns = document.querySelectorAll('button');
            btns.forEach(b => b.classList.add('opacity-50', 'cursor-not-allowed'));

            // Initial State: Untagged
            updatePacketUI('untagged', vlanId);
            packet.classList.remove('hidden');
            packet.style.opacity = '1';
            
            // 1. Source PC
            const startPos = getCenter(cfg.sourceId);
            packet.style.left = startPos.x + 'px';
            packet.style.top = startPos.y + 'px';
            packet.style.transition = 'none';
            
            log(`開始模擬: PC 發送封包到 VLAN ${vlanId}`, 'success');
            appendLog('封包產生：標準乙太網幀 (Untagged)');
            
            await new Promise(r => setTimeout(r, 100));
            packet.style.transition = 'top 1.2s ease-in-out, left 1.2s ease-in-out, width 0.3s ease';

            // 2. Move to Switch A Ingress (Access Port)
            await movePacket(cfg.sw1Ingress);
            log('Switch A: 收到封包 (Access Port)', 'action');
            appendLog(`Access Port 屬於 VLAN ${vlanId}。封包內無 Tag。`);

            // 3. Move to Switch A Egress (Trunk Port) - TAGGING HAPPENS HERE
            log('Switch A: 轉發至 Trunk', 'tag');
            appendLog('動作：插入 802.1Q 標籤 (Tagging)。封包結構改變。');
            updatePacketUI('tagged', vlanId); // Visually update packet & inspector
            
            await movePacket(cfg.sw1Egress);

            // 4. Travel across Trunk to Switch B
            log('傳輸中: Tagged 封包 (Trunk Link)', 'info');
            appendLog(`此時線路上可看見 VLAN ID: ${vlanId}。`, 'highlight');
            await movePacket(cfg.sw2Ingress);

            // 5. Switch B Processing
            log('Switch B: 收到 Tagged 封包', 'action');
            appendLog(`讀取到 VLAN ID: ${vlanId}。準備轉發。`);
            
            // 6. Move to Switch B Egress (Access Port) - UNTAGGING HAPPENS HERE
            log('Switch B: 轉發至 Access Port', 'tag');
            appendLog('動作：移除 802.1Q 標籤 (Untagging)。恢復原始結構。');
            updatePacketUI('untagged', vlanId); // Visually revert packet & inspector
            
            await movePacket(cfg.sw2Egress);

            // 7. Arrive at Destination
            await movePacket(cfg.destId);
            log('傳輸完成: 目標 PC 收到封包', 'success');
            appendLog('PC 成功讀取標準乙太網幀。');

            // Cleanup
            setTimeout(() => {
                packet.style.opacity = '0';
                isAnimating = false;
                btns.forEach(b => b.classList.remove('opacity-50', 'cursor-not-allowed'));
            }, 1000);
        }
    </script>
</body>
</html>