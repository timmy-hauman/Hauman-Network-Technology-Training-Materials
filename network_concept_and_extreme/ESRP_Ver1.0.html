<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExtremeXOS ESRP 深度架構教學 - L2/L3 與 Host Mode 解析</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .mermaid { display: flex; justify-content: center; margin: 20px 0; background-color: #f9fafb; padding: 10px; border-radius: 8px; }
        .tab-btn { border-bottom: 2px solid transparent; color: #6b7280; }
        .tab-active { border-bottom: 2px solid #6366f1; color: #6366f1; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header / Intro -->
    <header class="bg-slate-900 text-white p-8 shadow-lg">
        <div class="max-w-5xl mx-auto">
            <h1 class="text-3xl font-bold mb-2">ExtremeXOS ESRP 架構大師班</h1>
            <p class="text-gray-400">Extreme Standby Router Protocol：從 L2 到 L3，再到 MLAG Host Mode 的完整解析</p>
            <div class="mt-4 flex items-center space-x-4 text-sm text-yellow-400">
                <span>★ 20 年架構師觀點</span>
                <span>★ 取代 STP 的關鍵技術</span>
                <span>★ MLAG 核心元件</span>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto p-6 space-y-12">

        <!-- Section 1: Core Concept -->
        <section class="bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500">
            <h2 class="text-2xl font-bold mb-4 text-slate-800">一、核心概念 (Concept)</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-bold text-blue-600 mb-2">一句話定義</h3>
                    <p class="text-gray-700 leading-relaxed">
                        ESRP (Extreme Standby Router Protocol) 是 Extreme 獨家的備援協定，它像是一位「雙面特務」，既可以在 Layer 2 層級阻斷迴圈 (Loop) 來取代 STP，也可以在 Layer 3 層級提供虛擬閘道器 (Virtual Gateway) 來取代 VRRP。
                    </p>
                </div>
                <div>
                    <h3 class="font-bold text-orange-600 mb-2">生活化比喻</h3>
                    <p class="text-gray-700 leading-relaxed">
                        想像一家公司「總經理」(Master) 與「副總經理」(Slave)：
                        <br>
                        <strong>L2 模式 (Loop Protection)：</strong>為了避免命令打架 (Loop)，平時只有總經理能發號施令，副總經理把耳朵摀起來 (Port Blocked)，不聽也不傳任何公文。
                        <br>
                        <strong>Host Mode (MLAG 應用)：</strong>這是「代理授權模式」。副總經理 (Slave) 雖然頭銜還是副的，但被授權可以處理員工的公文 (收送封包)，只有在遇到總經理也在處理同一件事時，才會退讓。
                    </p>
                </div>
            </div>
        </section>

        <!-- Section 2: L2 vs L3 Architecture Tabs -->
        <section class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-6 text-slate-800">二、L2 與 L3 ESRP 架構深度解析</h2>
            
            <!-- Tabs Header -->
            <div class="flex border-b border-gray-200 mb-6 overflow-x-auto">
                <button onclick="switchTab('l2')" id="tab-l2" class="tab-btn tab-active px-6 py-2 transition-colors hover:text-indigo-600 whitespace-nowrap">L2 ESRP (取代 STP)</button>
                <button onclick="switchTab('l3')" id="tab-l3" class="tab-btn px-6 py-2 transition-colors hover:text-indigo-600 whitespace-nowrap">L3 ESRP (閘道備援)</button>
                <button onclick="switchTab('host')" id="tab-host" class="tab-btn px-6 py-2 transition-colors hover:text-indigo-600 whitespace-nowrap">★ Host Mode (MLAG 關鍵)</button>
            </div>

            <!-- Tab Content: L2 ESRP -->
            <div id="content-l2">
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="md:w-1/2 space-y-4">
                        <h3 class="text-xl font-bold text-indigo-700">L2 ESRP：Loop Protection</h3>
                        <p>在純 L2 環境中，ESRP 的作用與 STP (Spanning Tree) 完全相同，目的是<strong>防止廣播風暴與迴圈</strong>。</p>
                        <ul class="list-disc list-inside space-y-2 text-gray-700">
                            <li><strong>運作機制：</strong>Master Switch 的埠口全開；Slave Switch 會將受 ESRP 保護的 VLAN 埠口設為 <span class="bg-red-100 text-red-700 px-1 rounded">Blocked</span> 狀態。</li>
                            <li><strong>取代 STP 的優勢：</strong>
                                <ul class="pl-6 list-[circle] text-sm text-gray-600 mt-1">
                                    <li>收斂速度極快 (Hello timer 可設為 sub-second)。</li>
                                    <li>不需要全網計算 Tree，僅針對特定 VLAN 或 ESRP Domain。</li>
                                    <li>ESRP PDU (Hello) 透過 UDP 2056 傳送，包含 Master ID 與 Priority。</li>
                                </ul>
                            </li>
                            <li><strong>狀態行為：</strong>Slave 在此模式下，<strong>丟棄</strong>所有數據封包，只接收 ESRP Hello。</li>
                        </ul>
                    </div>
                    <div class="md:w-1/2 bg-gray-100 p-4 rounded border border-gray-200">
                        <h4 class="text-center font-bold text-gray-500 mb-2">架構圖：L2 Loop Protection</h4>
                        <div class="mermaid">
                            %%{init: {'flowchart': {'curve': 'linear'}}}%%
                            graph TD
                                L2_A["Core Switch A <br/> (ESRP Master)"]
                                L2_B["Core Switch B <br/> (ESRP Slave)"]
                                L2_Edge["Edge Switch"]
                                
                                L2_A -- "ESRP Hello (Active)" --- L2_B
                                L2_Edge -- "Link UP (Forwarding)" --- L2_A
                                L2_Edge -. "Link BLOCKED <br/> (Loop Prevention)" .- L2_B
                                
                                style L2_A fill:#d1fae5,stroke:#059669,stroke-width:2px
                                style L2_B fill:#fee2e2,stroke:#b91c1c,stroke-width:2px
                                style L2_Edge fill:#f3f4f6,stroke:#333,stroke-width:2px
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: L3 ESRP -->
            <div id="content-l3" class="hidden">
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="md:w-1/2 space-y-4">
                        <h3 class="text-xl font-bold text-indigo-700">L3 ESRP：Gateway Redundancy</h3>
                        <p>在 L3 環境中，ESRP 的作用類似 VRRP，提供預設閘道 (Default Gateway) 的高可用性。此架構展示標準的 Access-Core 設計。</p>
                        <ul class="list-disc list-inside space-y-2 text-gray-700">
                            <li><strong>架構調整：</strong>Client 透過 L2 Access Switch 上行連接至兩台 Core Switch，符合真實企業網路拓撲。</li>
                            <li><strong>虛擬 IP/MAC (單一 IP 架構)：</strong>
                                <ul class="pl-6 list-[square] text-sm text-gray-600 mt-1">
                                    <li><strong>ESRP 特性：</strong>兩台 Switch 的介面 IP 設定<strong>完全相同</strong>，且同時作為 VIP。例如 Master 設定 192.168.1.1，Slave 也設定 192.168.1.1。</li>
                                    <li><strong>與 VRRP 差異：</strong>VRRP 標準作法通常需要 3 個 IP (Master 介面 .2, Backup 介面 .3, 虛擬 VIP .1)；而 ESRP 兩台設備共用同一個 IP，不僅節省 IP 資源，設定也更為直觀。</li>
                                </ul>
                            </li>
                            <li><strong>運作機制：</strong>
                                <ul class="pl-6 list-[square] text-sm text-gray-600 mt-1">
                                    <li><strong>Master：</strong>回應 ARP Request，負責將流量 Routing 至上層 Internet。</li>
                                    <li><strong>Slave：</strong>介面 IP 雖然存在但保持靜默 (不回應 ARP)，不處理 Routing。</li>
                                </ul>
                            </li>
                            <li><strong>進階功能：</strong>ESRP 可以同時連動 L2 狀態 (如 Link down 自動切換) 與 L3 路由追蹤 (Route tracking)。</li>
                        </ul>
                    </div>
                    <div class="md:w-1/2 bg-gray-100 p-4 rounded border border-gray-200">
                        <h4 class="text-center font-bold text-gray-500 mb-2">架構圖：L3 Gateway Redundancy</h4>
                        <div class="mermaid">
                            %%{init: {'flowchart': {'curve': 'linear'}}}%%
                            graph TD
                                %% Top Layer: Internet
                                L3_Internet((Internet))

                                %% Core Layer
                                L3_CoreA["Switch A <br/> IP: 192.168.1.1 <br/> (Master)"]
                                L3_CoreB["Switch B <br/> IP: 192.168.1.1 <br/> (Slave)"]

                                %% Access Layer
                                L3_L2Sw["L2 Access Switch"]
                                L3_Client["PC / Server <br/> GW: 192.168.1.1"]

                                %% Connections - North (Upstream)
                                L3_CoreA -- "Active Routing" --> L3_Internet
                                L3_CoreB -. "Standby Routing" .-> L3_Internet
                                
                                %% ESRP Link
                                L3_CoreA <== "ESRP Sync" ==> L3_CoreB

                                %% Connections - South (Downstream)
                                L3_CoreA -- "Active Path" --- L3_L2Sw
                                L3_CoreB -. "Standby Path" .- L3_L2Sw

                                %% Access
                                L3_L2Sw --- L3_Client

                                %% Styling
                                style L3_CoreA fill:#d1fae5,stroke:#059669
                                style L3_CoreB fill:#fee2e2,stroke:#b91c1c
                                style L3_Internet fill:#fef3c7,stroke:#d97706
                                style L3_L2Sw fill:#e0f2fe,stroke:#0284c7
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Host Mode -->
            <div id="content-host" class="hidden">
                <div class="space-y-6">
                    <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4">
                        <h3 class="text-xl font-bold text-yellow-800 flex items-center">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            關鍵技術：ESRP Host Mode (ESRP Slave Active Forwarding)
                        </h3>
                        <p class="mt-2 text-yellow-900 font-medium">這是 Extreme MLAG 架構中最容易被誤解，但也最重要的觀念。</p>
                    </div>

                    <div class="grid md:grid-cols-2 gap-8">
                        <div>
                            <h4 class="font-bold text-lg mb-2">傳統 Slave vs. Host Mode Slave</h4>
                            <table class="w-full text-sm text-left text-gray-500 border">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-200">
                                    <tr>
                                        <th class="px-4 py-2">比較項目</th>
                                        <th class="px-4 py-2">傳統 ESRP Slave</th>
                                        <th class="px-4 py-2 text-blue-700">Host Mode Slave</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="bg-white border-b">
                                        <td class="px-4 py-2 font-medium">埠口狀態</td>
                                        <td class="px-4 py-2 text-red-600">Blocked (阻塞)</td>
                                        <td class="px-4 py-2 text-green-600">Forwarding (轉發)</td>
                                    </tr>
                                    <tr class="bg-gray-50 border-b">
                                        <td class="px-4 py-2 font-medium">封包收送</td>
                                        <td class="px-4 py-2">丟棄所有 Data 封包</td>
                                        <td class="px-4 py-2 font-bold">正常接收與傳送</td>
                                    </tr>
                                    <tr class="bg-white">
                                        <td class="px-4 py-2 font-medium">應用場景</td>
                                        <td class="px-4 py-2">單純 L2 環路保護</td>
                                        <td class="px-4 py-2">MLAG (Active-Active)</td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="mt-4 text-gray-700">
                                <p><strong>為什麼 MLAG 需要 Host Mode？</strong></p>
                                <p class="text-sm mt-1">在 MLAG 架構下，Server 透過 LACP 連接到兩台 Switch。如果 Slave 處於傳統模式並 Block 埠口，那 Server 的一半頻寬就斷了！</p>
                                <div class="bg-indigo-50 border-l-4 border-indigo-500 p-3 mt-3">
                                    <p class="font-bold text-indigo-800 text-sm">關鍵指令 (Correct CLI)：</p>
                                    <code class="block bg-gray-800 text-white p-2 rounded mt-1 text-xs">
                                        configure esrp &lt;esrp-name&gt; ports &lt;port_list&gt; mode host
                                    </code>
                                    <p class="text-xs text-indigo-700 mt-1">使用此指令將 ISC Link 和 Downlink Port 設為 Host Mode，確保在 Slave 狀態下仍能轉發封包。</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-100 p-4 rounded border border-gray-200">
                            <h4 class="text-center font-bold text-gray-500 mb-2">架構圖：MLAG + ESRP Host Mode</h4>
                            <div class="mermaid">
                                %%{init: {'flowchart': {'curve': 'linear'}}}%%
                                graph TD
                                    Host_CoreA["Switch A <br/> (ESRP Master) <br/> MLAG Primary"]
                                    Host_CoreB["Switch B <br/> (ESRP Slave) <br/> MLAG Secondary"]
                                    Host_Server["Server / Host"]

                                    Host_CoreA <== "ISC Link <br/> (Host Mode Configured)" ==> Host_CoreB
                                    
                                    Host_Server -- "LACP Active Link" --> Host_CoreA
                                    Host_Server -- "LACP Active Link <br/> (Host Mode Configured)" --> Host_CoreB
                                    
                                    subgraph "MLAG Domain"
                                    Host_CoreA
                                    Host_CoreB
                                    end

                                    style Host_CoreA fill:#d1fae5,stroke:#059669
                                    style Host_CoreB fill:#e0f2fe,stroke:#0284c7,stroke-dasharray: 5 5
                                    style Host_Server fill:#f3f4f6,stroke:#333
                            </div>
                            <p class="text-xs text-center text-gray-500 mt-2">注意：Host Mode 必須設定在 ISC 與 Downlink Port 上，Slave 才會保持這些連線暢通！</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 3: Use Case -->
        <section class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-4 text-slate-800">四、實務應用場景 (Use Case)</h2>
            <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                <h3 class="font-bold text-lg text-slate-700 mb-2">案例：資料中心高可用性架構 (Extreme MLAG)</h3>
                <p class="text-gray-700 mb-4">
                    某大型醫院的核心網路，要求伺服器連線不能中斷，且頻寬需最大化。
                </p>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <h4 class="font-bold text-green-600">解決方案配置</h4>
                        <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                            <li>使用兩台 Extreme Switch 組成 MLAG Pair。</li>
                            <li>設定 ESRP 進行 Gateway 備援 (VIP)。</li>
                            <li><strong>關鍵設定 (Host Mode)：</strong>必須在以下兩處 Port 上啟用正確指令：
                                <div class="bg-gray-100 border border-gray-300 p-2 mt-2 rounded font-mono text-xs text-gray-700">
                                    configure esrp "v1" ports &lt;port_list&gt; mode host
                                </div>
                                <ul class="pl-6 list-[circle] mt-2 text-red-600 font-bold text-sm">
                                    <li>1. 兩台 Switch 對接的 ISC Port</li>
                                    <li>2. 兩台 Switch 下行到 Server/Switch 的 Port</li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold text-blue-600">優點分析</h4>
                        <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                            <li><strong>頻寬翻倍：</strong>Server 的兩條線路同時運作 (Active-Active)。</li>
                            <li><strong>無縫切換：</strong>若 Master 當機，Slave 已經在轉發封包，且瞬間接手 VIP，使用者無感。</li>
                            <li><strong>結構簡單：</strong>完全不需要 STP 計算，卻擁有無 Loop 的環境。</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 4: Quiz -->
        <section class="bg-white p-6 rounded-lg shadow-md mb-10">
            <h2 class="text-2xl font-bold mb-4 text-slate-800">五、隨堂測驗 (Quiz)</h2>
            <p class="text-sm text-gray-500 mb-6">請測試你對 ESRP 與 Host Mode 的理解。</p>
            
            <div class="space-y-4" id="quiz-container">
                <!-- Q1 -->
                <div class="border-b pb-4">
                    <p class="font-bold text-gray-800">1. ESRP 的主要功能可以取代哪些標準協定？</p>
                    <div class="mt-2 space-y-2">
                        <label class="block"><input type="radio" name="q1" value="a"> A. 僅 STP</label>
                        <label class="block"><input type="radio" name="q1" value="b"> B. 僅 VRRP</label>
                        <label class="block"><input type="radio" name="q1" value="c"> C. STP (L2保護) 與 VRRP (L3備援)</label>
                        <label class="block"><input type="radio" name="q1" value="d"> D. OSPF</label>
                    </div>
                    <div class="answer hidden mt-2 text-sm text-green-700 bg-green-50 p-2 rounded">
                        <strong>答案：C</strong> <br>解析：ESRP 具備 L2 Loop Protection (取代 STP) 與 L3 Gateway Redundancy (取代 VRRP) 的雙重功能。
                    </div>
                </div>

                <!-- Q2 -->
                <div class="border-b pb-4">
                    <p class="font-bold text-gray-800">2. 在標準的 L2 ESRP 模式下 (非 Host Mode)，Slave 設備的狀態為何？</p>
                    <div class="mt-2 space-y-2">
                        <label class="block"><input type="radio" name="q2" value="a"> A. 埠口全開，負責負載平衡</label>
                        <label class="block"><input type="radio" name="q2" value="b"> B. 埠口 Blocked，丟棄資料封包，只收 ESRP Hello</label>
                        <label class="block"><input type="radio" name="q2" value="c"> C. 埠口 Blocked，但持續發送 Routing Update</label>
                    </div>
                    <div class="answer hidden mt-2 text-sm text-green-700 bg-green-50 p-2 rounded">
                        <strong>答案：B</strong> <br>解析：標準 L2 ESRP 為了防止迴圈，Slave 會將受保護的 VLAN 埠口設為 Blocked 狀態，行為類似 STP Blocking。
                    </div>
                </div>

                <!-- Q3 -->
                <div class="border-b pb-4">
                    <p class="font-bold text-gray-800">3. 為什麼在 MLAG 架構下，ESRP 必須開啟 "Host Mode"？</p>
                    <div class="mt-2 space-y-2">
                        <label class="block"><input type="radio" name="q3" value="a"> A. 為了加快開機速度</label>
                        <label class="block"><input type="radio" name="q3" value="b"> B. 為了讓 Slave 變成 Master</label>
                        <label class="block"><input type="radio" name="q3" value="c"> C. 為了讓 Slave 處於 Slave 狀態時仍能轉發資料封包</label>
                    </div>
                    <div class="answer hidden mt-2 text-sm text-green-700 bg-green-50 p-2 rounded">
                        <strong>答案：C</strong> <br>解析：MLAG 要求雙活 (Active-Active)，若 Slave 阻斷流量會導致連接到 Secondary Switch 的線路中斷。Host Mode 允許 Slave 在不造成迴圈的前提下轉發封包。
                    </div>
                </div>

                <!-- Q4 -->
                <div class="border-b pb-4">
                    <p class="font-bold text-gray-800">4. ESRP 使用哪種封包進行 Master/Slave 溝通？</p>
                    <div class="mt-2 space-y-2">
                        <label class="block"><input type="radio" name="q4" value="a"> A. TCP 80</label>
                        <label class="block"><input type="radio" name="q4" value="b"> B. UDP 2056 (Hello Packet)</label>
                        <label class="block"><input type="radio" name="q4" value="c"> C. ICMP Echo</label>
                    </div>
                    <div class="answer hidden mt-2 text-sm text-green-700 bg-green-50 p-2 rounded">
                        <strong>答案：B</strong> <br>解析：ESRP 使用專屬的 EDP/ESRP 封包，通常運作在 UDP Port 2056。
                    </div>
                </div>

                <!-- Q5 -->
                <div class="border-b pb-4">
                    <p class="font-bold text-gray-800">5. 關於 L3 ESRP 的 Gateway 備援，下列敘述何者正確？</p>
                    <div class="mt-2 space-y-2">
                        <label class="block"><input type="radio" name="q5" value="a"> A. 每個 Client 需要設定兩個 Gateway IP</label>
                        <label class="block"><input type="radio" name="q5" value="b"> B. Master 和 Slave 共用一個 Virtual IP (VIP)</label>
                        <label class="block"><input type="radio" name="q5" value="c"> C. 只有 Slave 擁有 IP，Master 沒有 IP</label>
                    </div>
                    <div class="answer hidden mt-2 text-sm text-green-700 bg-green-50 p-2 rounded">
                        <strong>答案：B</strong> <br>解析：如同 VRRP，L3 ESRP 提供一個虛擬 IP 給 Client 當 Gateway，平時由 Master 負責回應 ARP。
                    </div>
                </div>
            </div>
            
            <button onclick="toggleAnswers()" class="mt-6 bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700 transition">顯示/隱藏 答案與解析</button>
        </section>

    </main>

    <!-- Signature Footer -->
    <footer class="bg-gray-800 text-gray-400 text-center py-6 mt-12 text-sm">
        <p>Planning & Design by Timmy(timmyc@hauman.com.tw) | 豪勉科技 Hauman Technologies Corporation | Ver 1.0</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 1. 初始化
            mermaid.initialize({ 
                startOnLoad: false, 
                theme: 'neutral',
                securityLevel: 'loose',
                flowchart: {
                    curve: 'linear', 
                    htmlLabels: true
                }
            });

            // 2. 手動渲染第一個可見的 Tab (L2)
            // 使用 setTimeout 確保 DOM 渲染完成
            setTimeout(() => {
                renderMermaidInTab('l2');
            }, 100);
        });

        function toggleAnswers() {
            const answers = document.querySelectorAll('.answer');
            answers.forEach(ans => {
                ans.classList.toggle('hidden');
            });
        }

        function switchTab(tabId) {
            // 隱藏所有 Tab 內容
            const tabs = ['l2', 'l3', 'host'];
            tabs.forEach(id => {
                const el = document.getElementById('content-' + id);
                if (el) el.classList.add('hidden');
                
                // 重置按鈕樣式
                const btn = document.getElementById('tab-' + id);
                if (btn) {
                    btn.classList.remove('tab-active', 'font-bold', 'text-indigo-600');
                    btn.classList.add('text-gray-500');
                }
            });

            // 顯示選定的 Tab 內容
            const activeEl = document.getElementById('content-' + tabId);
            if (activeEl) {
                activeEl.classList.remove('hidden');
                
                // 設定按鈕啟用樣式
                const activeBtn = document.getElementById('tab-' + tabId);
                if (activeBtn) {
                    activeBtn.classList.add('tab-active', 'font-bold', 'text-indigo-600');
                    activeBtn.classList.remove('text-gray-500');
                }

                // 關鍵修正：延遲執行 Mermaid 渲染，確保 display:none 已移除且容器有寬度
                setTimeout(() => {
                    renderMermaidInTab(tabId);
                }, 50);
            }
        }

        // 負責渲染特定 Tab 內的 Mermaid 圖表
        function renderMermaidInTab(tabId) {
            const content = document.getElementById('content-' + tabId);
            if (!content) return;

            // 找出該 Tab 下所有的 .mermaid 區塊
            const graphs = content.querySelectorAll('.mermaid');
            
            // 過濾出尚未渲染過的圖表 (沒有 SVG 子元素)
            const unprocessedGraphs = Array.from(graphs).filter(graph => !graph.querySelector('svg'));

            if (unprocessedGraphs.length > 0) {
                mermaid.run({
                    nodes: unprocessedGraphs
                });
            }
        }
    </script>
</body>
</html>