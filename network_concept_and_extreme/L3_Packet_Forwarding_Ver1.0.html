<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L3 Switch 路由完整雙向教學 (MAC 修正版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Layout & Boxes */
        /* Enforce min-width on canvas to prevent overlapping on small screens */
        #canvas-area {
            min-width: 1280px; 
            overflow-x: auto;
        }

        .device-box {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 20; 
            background-color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Center align correction */
            transform: translateX(-50%);
        }
        
        .table-box {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.98);
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            padding: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 10;
            transition: all 0.3s ease;
            font-size: 0.65rem;
            white-space: nowrap; 
        }

        /* Helper for table positioning anchor */
        .anchor-center { transform: translateX(-50%); }
        /* Removed anchor-left/right classes in favor of Tailwind utility classes */
        
        /* Animations */
        .learning-arp {
            animation: flashGreen 1.5s ease-out;
            border-color: #22c55e !important;
            border-width: 2px !important;
        }
        @keyframes flashGreen {
            0% { background-color: #dcfce7; box-shadow: 0 0 15px #22c55e; }
            100% { background-color: rgba(255, 255, 255, 0.95); box-shadow: none; }
        }

        .learning-mac {
            animation: flashBlue 1.5s ease-out;
            border-color: #3b82f6 !important;
            border-width: 2px !important;
        }
        @keyframes flashBlue {
            0% { background-color: #dbeafe; box-shadow: 0 0 15px #3b82f6; }
            100% { background-color: rgba(255, 255, 255, 0.95); box-shadow: none; }
        }

        .packet {
            transition: all 1.2s cubic-bezier(0.45, 0.05, 0.55, 0.95);
            z-index: 50;
            transform: translate(-50%, -50%);
        }
        .line {
            position: absolute;
            height: 6px;
            background-color: #94a3b8;
            z-index: 0;
            transform-origin: left center;
            border-radius: 3px;
        }
        
        /* Packet Log Styling */
        .packet-frame {
            display: flex;
            border: 1px solid #475569;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.65rem;
            width: 100%;
        }
        .frame-header {
            background-color: #e2e8f0;
            padding: 4px 8px;
            border-right: 1px solid #94a3b8;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 280px; 
            flex-shrink: 0;
        }
        .frame-body-ip {
            background-color: #dbeafe;
            padding: 4px 8px;
            border-right: 1px solid #93c5fd;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 220px;
        }
        .frame-body-arp {
            background-color: #fef9c3;
            padding: 4px 8px;
            border-right: 1px solid #fde047;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 220px;
        }
        .frame-payload {
            background-color: #f3f4f6;
            padding: 4px;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 50px;
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-slate-800 text-white p-3 shadow-md flex justify-between items-center z-10 shrink-0">
        <div>
            <h1 class="text-lg font-bold">L3 Switch 路由完整雙向教學 (MAC 修正版)</h1>
            <p class="text-xs text-slate-300">架構: Host A &harr; L3 Switch 1 &harr; L3 Switch 2 &harr; Host B</p>
        </div>
        <div class="flex gap-2">
            <button onclick="resetSimulation()" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-xs font-bold shadow transition">重新開始</button>
            <button id="nextBtn" onclick="nextStep()" class="bg-green-500 hover:bg-green-600 px-4 py-1 rounded text-xs font-bold shadow transition animate-bounce">下一步</button>
        </div>
    </header>

    <!-- Top: Canvas Area (60%) -->
    <div class="relative bg-white border-b-4 border-slate-300 shrink-0 h-[60%]" id="canvas-area">
        
        <!-- Step Overlay -->
        <div class="absolute top-2 left-2 bg-yellow-50 border-l-4 border-yellow-500 p-3 shadow-md z-30 max-w-sm rounded opacity-90 hover:opacity-100 transition pointer-events-none">
            <h3 class="font-bold text-yellow-900 text-sm">步驟 <span id="step-num">0</span>: <span id="step-title">準備開始</span></h3>
            <p class="text-xs text-gray-700 mt-1" id="step-desc">Host A 準備發送資料給 Host B。</p>
        </div>

        <!-- Devices Container -->
        <div class="relative w-full h-full text-xs">
            
            <!-- Lines (Centers: 5%, 30%, 70%, 95%) -->
            <!-- A (5%) to SW1 (30%) -->
            <div class="line" style="top: 23%; left: 5%; width: 25%;"></div> 
            <!-- SW1 (30%) to SW2 (70%) -->
            <div class="line" style="top: 23%; left: 30%; width: 40%;"></div> 
            <!-- SW2 (70%) to B (95%) -->
            <div class="line" style="top: 23%; left: 70%; width: 25%;"></div>

            <!-- Host A (Center: 5%) -->
            <div class="device-box absolute top-[15%] left-[5%] w-44 border-2 border-blue-500 rounded bg-blue-50 p-2">
                <div class="font-bold text-blue-800 text-sm mb-1">Host A</div>
                <div class="text-gray-700 font-mono text-[9px] w-full text-center">192.168.1.10/24</div>
                <div class="text-gray-500 font-mono text-[9px] w-full text-center">00:00:00:00:00:AA</div>
                <div class="text-blue-600 font-bold text-[9px] mt-1 border-t border-blue-200 pt-1 w-full text-center">GW: 192.168.1.254</div>
            </div>
            <!-- Host A ARP Table (FIXED: Anchored Left to avoid cut-off) -->
            <div id="box-arp-a" class="table-box top-[42%] left-[1%] w-auto min-w-[220px]">
                <div class="font-bold text-blue-800 border-b border-blue-100 mb-1">Host A ARP Table</div>
                <table class="w-full text-left text-[8px]">
                    <thead><tr><th>IP</th><th class="text-right">MAC Address</th></tr></thead>
                    <tbody id="table-arp-a"></tbody>
                </table>
            </div>

            <!-- L3 Switch 1 (Center: 30%) - MACs Fixed -->
            <div class="device-box absolute top-[15%] left-[30%] w-80 border-2 border-purple-600 rounded bg-purple-50 p-2">
                <div class="font-bold text-purple-800 text-sm mb-1">L3 Switch 1</div>
                <div class="flex justify-between w-full text-[9px] mt-1">
                    <div class="text-left w-1/2 border-r border-purple-200 pr-2">
                        <b class="text-purple-700">Port 1 (Left)</b><br>
                        <span class="font-mono text-gray-700">192.168.1.254/24</span><br>
                        <span class="font-mono text-gray-500">00:00:00:00:01:01</span>
                    </div>
                    <div class="text-right w-1/2 pl-2">
                        <b class="text-purple-700">Port 2 (Right)</b><br>
                        <span class="font-mono text-gray-700">10.0.0.1/30</span><br>
                        <span class="font-mono text-gray-500">00:00:00:00:01:02</span>
                    </div>
                </div>
            </div>
            <!-- SW1 Tables (Center: 30%) -->
            <div class="absolute top-[42%] left-[30%] w-auto min-w-[240px] flex flex-col gap-1 transform -translate-x-1/2">
                <div class="table-box relative w-full mb-1 border-purple-200 bg-white !transform-none">
                    <div class="font-bold text-purple-800 border-b border-purple-100 mb-1">Route Table</div>
                    <table class="w-full text-left whitespace-nowrap text-[8px]"><tbody id="table-route-sw1"></tbody></table>
                </div>
                <div id="box-arp-sw1" class="table-box relative w-full mb-1 border-purple-200 bg-white !transform-none">
                    <div class="font-bold text-purple-800 border-b border-purple-100 mb-1">ARP Table</div>
                    <table class="w-full text-left text-[8px]">
                        <thead><tr><th>IP</th><th class="text-right">MAC Address</th></tr></thead>
                        <tbody id="table-arp-sw1"></tbody>
                    </table>
                </div>
                <div id="box-mac-sw1" class="table-box relative w-full mb-1 border-purple-300 bg-purple-50 !transform-none">
                    <div class="font-bold text-purple-900 border-b border-purple-200 mb-1 flex justify-between">
                        <span>MAC Table</span>
                        <span class="text-[8px] text-purple-400 font-normal">L2 Learning</span>
                    </div>
                    <table class="w-full text-left text-[8px]">
                        <thead><tr class="text-gray-400"><th class="w-3/4">MAC Address</th><th>Port</th></tr></thead>
                        <tbody id="table-mac-sw1"></tbody>
                    </table>
                    <div id="empty-mac-sw1" class="text-gray-400 text-[8px] italic text-center py-1">Empty</div>
                </div>
            </div>

            <!-- L3 Switch 2 (Center: 70%) - MACs Fixed -->
            <div class="device-box absolute top-[15%] left-[70%] w-80 border-2 border-orange-600 rounded bg-orange-50 p-2">
                <div class="font-bold text-orange-800 text-sm mb-1">L3 Switch 2</div>
                <div class="flex justify-between w-full text-[9px] mt-1">
                    <div class="text-left w-1/2 border-r border-orange-200 pr-2">
                        <b class="text-orange-700">Port 1 (Left)</b><br>
                        <span class="font-mono text-gray-700">10.0.0.2/30</span><br>
                        <span class="font-mono text-gray-500">00:00:00:00:02:01</span>
                    </div>
                    <div class="text-right w-1/2 pl-2">
                        <b class="text-orange-700">Port 2 (Right)</b><br>
                        <span class="font-mono text-gray-700">192.168.2.254/24</span><br>
                        <span class="font-mono text-gray-500">00:00:00:00:02:02</span>
                    </div>
                </div>
            </div>
             <!-- SW2 Tables (Center: 70%) -->
             <div class="absolute top-[42%] left-[70%] w-auto min-w-[240px] flex flex-col gap-1 transform -translate-x-1/2">
                <div class="table-box relative w-full mb-1 border-orange-200 bg-white !transform-none">
                    <div class="font-bold text-orange-800 border-b border-orange-100 mb-1">Route Table</div>
                    <table class="w-full text-left whitespace-nowrap text-[8px]"><tbody id="table-route-sw2"></tbody></table>
                </div>
                <div id="box-arp-sw2" class="table-box relative w-full mb-1 border-orange-200 bg-white !transform-none">
                    <div class="font-bold text-orange-800 border-b border-orange-100 mb-1">ARP Table</div>
                    <table class="w-full text-left text-[8px]">
                        <thead><tr><th>IP</th><th class="text-right">MAC Address</th></tr></thead>
                        <tbody id="table-arp-sw2"></tbody>
                    </table>
                </div>
                <div id="box-mac-sw2" class="table-box relative w-full mb-1 border-orange-300 bg-orange-50 !transform-none">
                    <div class="font-bold text-orange-900 border-b border-orange-200 mb-1 flex justify-between">
                        <span>MAC Table</span>
                        <span class="text-[8px] text-orange-400 font-normal">L2 Learning</span>
                    </div>
                    <table class="w-full text-left text-[8px]">
                        <thead><tr class="text-gray-400"><th class="w-3/4">MAC Address</th><th>Port</th></tr></thead>
                        <tbody id="table-mac-sw2"></tbody>
                    </table>
                    <div id="empty-mac-sw2" class="text-gray-400 text-[8px] italic text-center py-1">Empty</div>
                </div>
            </div>

            <!-- Host B (Center: 95%) -->
            <div class="device-box absolute top-[15%] left-[95%] w-44 border-2 border-green-500 rounded bg-green-50 p-2">
                <div class="font-bold text-green-800 text-sm mb-1">Host B</div>
                <div class="text-gray-700 font-mono text-[9px] w-full text-center">192.168.2.10/24</div>
                <div class="text-gray-500 font-mono text-[9px] w-full text-center">00:00:00:00:00:BB</div>
                <div class="text-green-600 font-bold text-[9px] mt-1 border-t border-green-200 pt-1 w-full text-center">GW: 192.168.2.254</div>
            </div>
            <!-- Host B ARP Table (FIXED: Anchored Right to avoid cut-off) -->
            <div id="box-arp-b" class="table-box top-[42%] right-[1%] left-auto w-auto min-w-[220px]">
                <div class="font-bold text-green-800 border-b border-green-100 mb-1">Host B ARP Table</div>
                <table class="w-full text-left text-[8px]">
                    <thead><tr><th>IP</th><th class="text-right">MAC Address</th></tr></thead>
                    <tbody id="table-arp-b"></tbody>
                </table>
            </div>

            <!-- Packet -->
            <div id="packet" class="packet hidden absolute w-12 h-8 bg-yellow-300 border-2 border-yellow-600 rounded flex items-center justify-center text-[10px] font-bold shadow-lg top-[20%] left-[5%]">
                Pkt
            </div>
        </div>
    </div>

    <!-- Bottom: Log (Flex-1 to fill remaining space) -->
    <div class="flex-1 bg-slate-50 border-t border-slate-300 flex flex-col min-h-0">
        <div class="p-2 bg-slate-200 font-bold text-slate-700 text-sm flex justify-between items-center shadow-sm shrink-0">
            <span>封包傳輸紀錄 & 結構解析</span>
            <span class="text-xs font-normal text-slate-500">順序：時間軸 (第一步在最上方，最新步在最下方)</span>
        </div>
        <div id="log-container" class="flex-1 overflow-y-auto p-4 space-y-4 min-h-0">
            <div id="log-placeholder" class="text-center text-gray-400 text-sm mt-4">請點擊「下一步」開始模擬。</div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-slate-900 text-slate-400 text-[10px] p-1 text-center shrink-0 border-t border-slate-700">
        Planning & Design by Timmy(timmyc@hauman.com.tw) | 豪勉科技 Hauman Technologies Corporation | Ver 1.0
    </footer>

    <script>
        let currentStep = 0;
        
        // Data Models - Fixed MACs
        const data = {
            hostA: { ip: "192.168.1.10", mac: "00:00:00:00:00:AA", arp: [] },
            hostB: { ip: "192.168.2.10", mac: "00:00:00:00:00:BB", arp: [] }, 
            l3sw1: { 
                int1: { ip: "192.168.1.254", mac: "00:00:00:00:01:01" }, // Fixed MAC
                int2: { ip: "10.0.0.1", mac: "00:00:00:00:01:02" },      // Fixed MAC
                macTable: [],
                arp: [],
                routes: [
                    { type: 'S', net: '192.168.2.0/24', next: '10.0.0.2' },
                    { type: 'C', net: '192.168.1.0/24', next: 'Port 1' },
                    { type: 'C', net: '10.0.0.0/30', next: 'Port 2' }
                ]
            },
            l3sw2: {
                int1: { ip: "10.0.0.2", mac: "00:00:00:00:02:01" },      // Fixed MAC
                int2: { ip: "192.168.2.254", mac: "00:00:00:00:02:02" }, // Fixed MAC
                macTable: [],
                arp: [],
                routes: [
                    { type: 'S', net: '192.168.1.0/24', next: '10.0.0.1' },
                    { type: 'C', net: '10.0.0.0/30', next: 'Port 1' },
                    { type: 'C', net: '192.168.2.0/24', next: 'Port 2' }
                ]
            }
        };

        const packetEl = document.getElementById('packet');
        const nextBtn = document.getElementById('nextBtn');
        const logContainer = document.getElementById('log-container');

        function renderTables() {
            const row = (ip, mac) => `<tr><td class="pr-2 text-gray-600">${ip}</td><td class="font-mono text-[9px] text-gray-800 text-right">${mac}</td></tr>`;
            const routeRow = (t, n, nh) => `<tr><td class="font-bold ${t==='S'?'text-red-500':'text-gray-500'} w-4">${t}</td><td class="pr-1 text-[9px]">${n}</td><td class="text-gray-600 text-[9px]">${nh}</td></tr>`;
            const macRow = (m, p) => `<tr><td class="font-mono text-[9px] text-blue-800">${m}</td><td class="text-gray-600 text-right text-[9px]">${p}</td></tr>`;

            document.getElementById('table-arp-a').innerHTML = data.hostA.arp.map(e => row(e.ip, e.mac)).join('');
            document.getElementById('table-arp-b').innerHTML = data.hostB.arp.map(e => row(e.ip, e.mac)).join(''); 
            
            // L3 SW1
            document.getElementById('table-arp-sw1').innerHTML = data.l3sw1.arp.map(e => row(e.ip, e.mac)).join('');
            document.getElementById('table-route-sw1').innerHTML = data.l3sw1.routes.map(r => routeRow(r.type, r.net, r.next)).join('');
            document.getElementById('table-mac-sw1').innerHTML = data.l3sw1.macTable.map(e => macRow(e.mac, e.port)).join('');
            document.getElementById('empty-mac-sw1').style.display = data.l3sw1.macTable.length ? 'none' : 'block';

            // L3 SW2
            document.getElementById('table-arp-sw2').innerHTML = data.l3sw2.arp.map(e => row(e.ip, e.mac)).join('');
            document.getElementById('table-route-sw2').innerHTML = data.l3sw2.routes.map(r => routeRow(r.type, r.net, r.next)).join('');
            document.getElementById('table-mac-sw2').innerHTML = data.l3sw2.macTable.map(e => macRow(e.mac, e.port)).join('');
            document.getElementById('empty-mac-sw2').style.display = data.l3sw2.macTable.length ? 'none' : 'block';
        }

        function highlightTable(elementId, type = 'arp') {
            const el = document.getElementById(elementId);
            const className = type === 'mac' ? 'learning-mac' : 'learning-arp';
            el.classList.remove('learning-arp', 'learning-mac');
            void el.offsetWidth; 
            el.classList.add(className);
        }

        function movePacket(top, left) {
            packetEl.style.top = top;
            packetEl.style.left = left;
        }

        function showPacket(visible) {
            if(visible) packetEl.classList.remove('hidden');
            else packetEl.classList.add('hidden');
        }

        // Horizontal Log Format (APPEND mode for chronological view)
        function logPacket(stepName, type, smac, dmac, sip, dip, desc) {
            const placeholder = document.getElementById('log-placeholder');
            if (placeholder) {
                placeholder.remove();
            }
            
            const isArp = type.includes('ARP');
            const etherType = isArp ? '0x0806 (ARP)' : '0x0800 (IPv4)';
            
            const card = document.createElement('div');
            card.className = "bg-white border border-gray-300 rounded shadow-sm animate-fade-in";
            
            let packetContent = '';

            if (isArp) {
                packetContent = `
                    <div class="packet-frame border-yellow-400">
                        <div class="frame-header bg-gray-100">
                            <div class="text-[9px] text-gray-500 uppercase tracking-wider mb-1 font-bold">Ethernet II</div>
                            <div class="flex gap-3 text-[10px]">
                                <div><span class="text-gray-500">Dst MAC:</span> <span class="font-bold text-red-600 font-mono">${dmac}</span></div>
                                <div><span class="text-gray-500">Src MAC:</span> <span class="font-bold text-blue-600 font-mono">${smac}</span></div>
                            </div>
                            <div class="text-[9px] text-gray-400 mt-1 pl-1">Type: ${etherType}</div>
                        </div>
                        <div class="frame-body-arp bg-yellow-50">
                            <div class="text-[9px] text-yellow-700 uppercase tracking-wider font-bold mb-1">ARP Payload</div>
                            <div class="flex flex-col gap-1 text-[10px]">
                                <div class="flex gap-3">
                                    <div><span class="text-gray-500">Snd IP:</span> <b class="font-mono">${sip}</b></div>
                                    <div><span class="text-gray-500">Tgt IP:</span> <b class="font-mono">${dip}</b></div>
                                </div>
                                <div class="flex gap-3">
                                    <div><span class="text-gray-500">Snd MAC:</span> <b class="font-mono">${smac}</b></div>
                                    <div><span class="text-gray-500">Tgt MAC:</span> <b class="font-mono">${dmac === 'FF:FF:FF:FF:FF:FF' ? '?' : dmac}</b></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                packetContent = `
                    <div class="packet-frame border-blue-400">
                        <div class="frame-header bg-gray-100">
                            <div class="text-[9px] text-gray-500 uppercase tracking-wider mb-1 font-bold">Ethernet II</div>
                            <div class="flex gap-3 text-[10px]">
                                <div><span class="text-gray-500">Dst MAC:</span> <span class="font-bold text-red-600 font-mono">${dmac}</span></div>
                                <div><span class="text-gray-500">Src MAC:</span> <span class="font-bold text-blue-600 font-mono">${smac}</span></div>
                            </div>
                            <div class="text-[9px] text-gray-400 mt-1 pl-1">Type: ${etherType}</div>
                        </div>
                        <div class="frame-body-ip bg-blue-50">
                            <div class="text-[9px] text-blue-700 uppercase tracking-wider font-bold mb-1">IPv4 Header</div>
                            <div class="flex gap-4 text-[10px]">
                                <div><span class="text-gray-500">Dst IP:</span> <b class="text-red-800 font-mono">${dip}</b></div>
                                <div><span class="text-gray-500">Src IP:</span> <b class="text-blue-800 font-mono">${sip}</b></div>
                            </div>
                            <div class="text-[9px] text-gray-400 mt-1 pl-1">Proto: ICMP (1) | TTL: 64</div>
                        </div>
                        <div class="frame-payload px-2 bg-slate-100 text-[10px] text-center">
                            Data
                        </div>
                    </div>
                `;
            }

            card.innerHTML = `
                <div class="p-2">
                    <div class="flex justify-between items-baseline mb-1">
                        <h4 class="font-bold text-slate-800 text-sm">${stepName}</h4>
                        <span class="text-xs px-2 py-0.5 rounded ${isArp ? 'bg-yellow-200 text-yellow-800' : 'bg-blue-200 text-blue-800'} font-bold">${type}</span>
                    </div>
                    <p class="text-xs text-gray-600 mb-2">${desc}</p>
                    ${packetContent}
                </div>
            `;
            
            logContainer.appendChild(card);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateStepInfo(num, title, desc) {
            document.getElementById('step-num').innerText = num;
            document.getElementById('step-title').innerText = title;
            document.getElementById('step-desc').innerText = desc;
        }

        // Coordinates
        const Y_LINE = '23%';
        const Y_SW = '28%';
        const X_A = '5%';
        const X_SW1_IN = '22%'; 
        const X_SW1_OUT = '42%'; 
        const X_SW2_IN = '58%'; 
        const X_SW2_OUT = '78%'; 
        const X_B = '95%';

        const steps = [
            { action: () => { showPacket(false); } },
            // 1. A -> Gateway ARP
            {
                title: "ARP 請求 (A -> Gateway)",
                desc: "Host A (192.168.1.10) 欲送資料給 B (192.168.2.10)。Subnet 不同，需送 Gateway (192.168.1.254)。A 查無 Gateway MAC，發送 Broadcast ARP。",
                action: () => {
                    showPacket(true); movePacket(Y_LINE, X_A);
                    logPacket("1. ARP Request", "ARP Request", data.hostA.mac, "FF:FF:FF:FF:FF:FF", data.hostA.ip, data.l3sw1.int1.ip, "Host A 廣播：誰是 192.168.1.254？");
                }
            },
            { title: "傳輸至 SW1", desc: "ARP 請求經線路傳至 L3 Switch 1。", action: () => { movePacket(Y_LINE, '18.5%'); } },
            {
                title: "SW1: L2 MAC 學習", desc: "SW1 學習 Source MAC AA 到 Port 1。",
                action: () => {
                    movePacket(Y_SW, X_SW1_IN);
                    if(!data.l3sw1.macTable.find(m => m.mac === data.hostA.mac)) {
                        data.l3sw1.macTable.push({ mac: data.hostA.mac, port: 'Port 1' });
                    }
                    renderTables(); highlightTable('box-mac-sw1', 'mac');
                }
            },
            {
                title: "SW1: ARP 回覆", desc: "SW1 學習 A IP 並回覆 ARP Reply。",
                action: () => {
                    data.l3sw1.arp.push({ ip: data.hostA.ip, mac: data.hostA.mac });
                    renderTables(); highlightTable('box-arp-sw1', 'arp');
                    showPacket(true);
                    logPacket("4. ARP Reply", "ARP Reply", data.l3sw1.int1.mac, data.hostA.mac, data.l3sw1.int1.ip, data.hostA.ip, "SW1 回覆：我是 192.168.1.254，MAC 是 ...:01:01");
                }
            },
            { title: "回覆傳輸至 A", desc: "ARP Reply 傳回 Host A。", action: () => { movePacket(Y_LINE, '18.5%'); } },
            {
                title: "Host A 更新 ARP", desc: "Host A 學習 Gateway MAC。",
                action: () => {
                    movePacket(Y_LINE, X_A);
                    data.hostA.arp.push({ ip: data.l3sw1.int1.ip, mac: data.l3sw1.int1.mac });
                    renderTables(); highlightTable('box-arp-a'); showPacket(false);
                }
            },
            {
                title: "發送 ICMP Request (A->B)", desc: "Host A 封裝 ICMP。Dst IP: 192.168.2.10, Dst MAC: SW1(P1)。",
                action: () => {
                    showPacket(true);
                    logPacket("7. ICMP Req (A->SW1)", "IP Packet", data.hostA.mac, data.l3sw1.int1.mac, data.hostA.ip, data.hostB.ip, "IP Dst 是 Host B，MAC Dst 是 Gateway。");
                }
            },
            { title: "傳輸至 SW1", desc: "封包抵達 SW1。", action: () => { movePacket(Y_LINE, '18.5%'); } },
            {
                title: "SW1: 路由與 ARP 請求", desc: "SW1 查路由往 10.0.0.2。ARP 無紀錄，發 ARP Req。",
                action: () => {
                    movePacket(Y_SW, X_SW1_IN); highlightTable('box-mac-sw1', 'mac'); // Refresh MAC
                    logPacket("10. ARP Request", "ARP Request", data.l3sw1.int2.mac, "FF:FF:FF:FF:FF:FF", data.l3sw1.int2.ip, data.l3sw2.int1.ip, "SW1 廣播：誰是 10.0.0.2？");
                }
            },
            { title: "傳輸至 SW2", desc: "ARP 傳至 SW2。", action: () => { movePacket(Y_LINE, '50%'); } },
            {
                title: "SW2: L2 MAC 學習", desc: "SW2 學習 SW1 MAC 到 Port 1。",
                action: () => {
                    movePacket(Y_SW, X_SW2_IN);
                    if(!data.l3sw2.macTable.find(m => m.mac === data.l3sw1.int2.mac)) {
                        data.l3sw2.macTable.push({ mac: data.l3sw1.int2.mac, port: 'Port 1' });
                    }
                    renderTables(); highlightTable('box-mac-sw2', 'mac');
                }
            },
            {
                title: "SW2: ARP 回覆", desc: "SW2 回覆 MAC。",
                action: () => {
                    data.l3sw2.arp.push({ ip: data.l3sw1.int2.ip, mac: data.l3sw1.int2.mac });
                    renderTables(); highlightTable('box-arp-sw2', 'arp');
                    logPacket("13. ARP Reply", "ARP Reply", data.l3sw2.int1.mac, data.l3sw1.int2.mac, data.l3sw2.int1.ip, data.l3sw1.int2.ip, "SW2 回覆 MAC。");
                }
            },
            { title: "回覆至 SW1", desc: "SW1 收到 SW2 MAC。", action: () => { movePacket(Y_LINE, '50%'); } },
            {
                title: "SW1: 轉發 (Hop 2)", desc: "SW1 更新 ARP。L3 轉發至 SW2。",
                action: () => {
                    movePacket(Y_SW, X_SW1_OUT);
                    data.l3sw1.arp.push({ ip: data.l3sw2.int1.ip, mac: data.l3sw2.int1.mac });
                    renderTables(); highlightTable('box-arp-sw1', 'arp');
                    if(!data.l3sw1.macTable.find(m => m.mac === data.l3sw2.int1.mac)) { data.l3sw1.macTable.push({mac:data.l3sw2.int1.mac,port:'Port 2'}); renderTables();} // Learn Reply MAC
                    logPacket("16. ICMP Req (SW1->SW2)", "IP Packet", data.l3sw1.int2.mac, data.l3sw2.int1.mac, data.hostA.ip, data.hostB.ip, "MAC 改變，IP 不變。");
                }
            },
            { title: "傳輸至 SW2", desc: "封包抵達 SW2。", action: () => { movePacket(Y_LINE, '50%'); } },
            {
                title: "SW2: 路由與 ARP 請求", desc: "SW2 查路由往 Host B (Connected)。ARP 無紀錄，發 Req。",
                action: () => {
                    movePacket(Y_SW, X_SW2_IN); highlightTable('box-mac-sw2', 'mac');
                    logPacket("19. ARP Request", "ARP Request", data.l3sw2.int2.mac, "FF:FF:FF:FF:FF:FF", data.l3sw2.int2.ip, data.hostB.ip, "SW2 廣播：誰是 192.168.2.10？");
                }
            },
            { title: "傳輸至 B", desc: "ARP 傳至 Host B。", action: () => { movePacket(Y_LINE, '81.5%'); } },
            {
                title: "Host B: 學習與回覆", desc: "Host B 收到 ARP Req，學習 Gateway，並回覆自己的 MAC。",
                action: () => {
                    movePacket(Y_LINE, X_B);
                    data.hostB.arp.push({ ip: data.l3sw2.int2.ip, mac: data.l3sw2.int2.mac });
                    renderTables(); highlightTable('box-arp-b', 'arp');
                    logPacket("21. ARP Reply", "ARP Reply", data.hostB.mac, data.l3sw2.int2.mac, data.hostB.ip, data.l3sw2.int2.ip, "Host B 學習 Gateway，並回覆 MAC。");
                }
            },
            { title: "回覆至 SW2", desc: "SW2 收到 Host B MAC。", action: () => { movePacket(Y_LINE, '81.5%'); } },
            {
                title: "SW2: 轉發 (Hop 3)", desc: "SW2 更新 ARP。L3 轉發至 Host B。",
                action: () => {
                    movePacket(Y_SW, X_SW2_OUT);
                    data.l3sw2.arp.push({ ip: data.hostB.ip, mac: data.hostB.mac });
                    renderTables(); highlightTable('box-arp-sw2', 'arp');
                    if(!data.l3sw2.macTable.find(m => m.mac === data.hostB.mac)) { data.l3sw2.macTable.push({mac:data.hostB.mac,port:'Port 2'}); renderTables();}
                    logPacket("24. ICMP Req (SW2->B)", "IP Packet", data.l3sw2.int2.mac, data.hostB.mac, data.hostA.ip, data.hostB.ip, "封包送達 Host B。");
                }
            },
            { title: "抵達 Host B", desc: "Host B 收到 ICMP Request。", action: () => { movePacket(Y_LINE, X_B); } },

            // --- Return Path (Echo Reply) ---
            {
                title: "Host B 產生 Reply",
                desc: "Host B 準備回覆。Src IP: B, Dst IP: A。GW: SW2。查 ARP 已知 SW2 MAC。",
                action: () => {
                    logPacket("26. ICMP Reply (B->SW2)", "IP Packet", data.hostB.mac, data.l3sw2.int2.mac, data.hostB.ip, data.hostA.ip, "回程：Src IP 變為 Host B，Dst IP 變為 Host A。");
                }
            },
            { title: "傳輸至 SW2", desc: "Reply 傳至 SW2。", action: () => { movePacket(Y_LINE, '81.5%'); } },
            {
                title: "SW2: 路由查表",
                desc: "SW2 收到。Dst IP 192.168.1.10。查表：Static Route 往 10.0.0.1 (Port 1)。ARP 已知下一跳 MAC。",
                action: () => {
                    movePacket(Y_SW, X_SW2_OUT); highlightTable('box-mac-sw2', 'mac'); // Refresh MAC of B
                }
            },
            {
                title: "SW2: 轉發 (Hop 1)",
                desc: "SW2 轉發給 SW1。Src MAC: SW2(P1), Dst MAC: SW1(P2)。",
                action: () => {
                    movePacket(Y_SW, X_SW2_IN);
                    logPacket("29. ICMP Reply (SW2->SW1)", "IP Packet", data.l3sw2.int1.mac, data.l3sw1.int2.mac, data.hostB.ip, data.hostA.ip, "SW2 路由轉發至 SW1。");
                }
            },
            { title: "傳輸至 SW1", desc: "Reply 傳至 SW1。", action: () => { movePacket(Y_LINE, '50%'); } },
            {
                title: "SW1: 路由查表",
                desc: "SW1 收到。Dst IP 192.168.1.10。查表：Connected (Port 1)。ARP 已知 Host A MAC。",
                action: () => {
                    movePacket(Y_SW, X_SW1_OUT); highlightTable('box-mac-sw1', 'mac'); // Refresh MAC
                }
            },
            {
                title: "SW1: 轉發 (Hop 2)",
                desc: "SW1 轉發給 Host A。Src MAC: SW1(P1), Dst MAC: Host A。",
                action: () => {
                    movePacket(Y_SW, X_SW1_IN);
                    logPacket("32. ICMP Reply (SW1->A)", "IP Packet", data.l3sw1.int1.mac, data.hostA.mac, data.hostB.ip, data.hostA.ip, "SW1 直連轉發至 Host A。");
                }
            },
            { title: "傳輸至 Host A", desc: "Reply 抵達 Host A。", action: () => { movePacket(Y_LINE, '18.5%'); } },
            {
                title: "Host A 接收",
                desc: "Host A 收到 ICMP Reply。Ping 成功！雙向通訊完成。",
                action: () => {
                    movePacket(Y_LINE, X_A);
                    nextBtn.innerText = "重置";
                    nextBtn.onclick = resetSimulation;
                    nextBtn.classList.remove('animate-bounce');
                }
            }
        ];

        function nextStep() {
            if (currentStep < steps.length - 1) {
                currentStep++;
                const step = steps[currentStep];
                updateStepInfo(currentStep, step.title, step.desc);
                step.action();
            }
        }

        function resetSimulation() {
            currentStep = 0;
            data.hostA.arp = [];
            data.hostB.arp = []; 
            data.l3sw1.arp = [];
            data.l3sw1.macTable = [];
            data.l3sw2.arp = [];
            data.l3sw2.macTable = [];
            renderTables();
            logContainer.innerHTML = '<div id="log-placeholder" class="text-center text-gray-400 text-sm mt-4">請點擊「下一步」開始模擬。</div>';
            packetEl.classList.add('hidden');
            nextBtn.innerText = "下一步";
            nextBtn.onclick = nextStep;
            updateStepInfo(0, "準備開始", "Host A 準備發送資料給 Host B。");
        }

        renderTables();
    </script>
</body>
</html>