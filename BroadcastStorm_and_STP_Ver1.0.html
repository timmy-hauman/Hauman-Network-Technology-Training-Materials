<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»£æ’­é¢¨æš´èˆ‡ STP äº’å‹•æ•™å­¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8;
            /* å…è¨±å‚ç›´æ²å‹•ä»¥é©æ‡‰æ–°çš„ä½ˆå±€ */
            overflow-y: auto; 
        }
        canvas {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            /* ç¢ºä¿ç•«å¸ƒåœ¨å°è¢å¹•ä¸Šè‡ªé©æ‡‰ç¸®æ”¾ */
            width: 100%;
            height: auto;
            max-width: 800px;
        }
        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(4px);
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen flex flex-col items-center justify-start p-4 pt-8">

    <!-- Header & Stats -->
    <div class="w-full max-w-4xl mb-4 flex flex-col sm:flex-row justify-between items-center text-slate-800 gap-2">
        <div>
            <h1 class="text-2xl font-bold text-blue-700">å»£æ’­é¢¨æš´ & STP äº’å‹•æ•™å­¸</h1>
            <p class="text-sm text-gray-600">è§€å¯Ÿå°åŒ…å¦‚ä½•åœ¨äº¤æ›å™¨ç’°è·¯ä¸­å‚³é</p>
        </div>
        <div class="text-right flex flex-col items-end">
            <div class="text-sm font-bold bg-white px-3 py-1 rounded shadow-sm">å°åŒ…æ•¸é‡: <span id="packet-count" class="text-green-600">0</span></div>
            <div id="storm-warning" class="text-xs text-red-600 font-bold hidden mt-1 bg-red-100 px-2 py-1 rounded animate-pulse">âš ï¸ åµæ¸¬åˆ°å»£æ’­é¢¨æš´ï¼</div>
        </div>
    </div>

    <!-- Main Canvas Area -->
    <div class="relative w-full max-w-4xl flex justify-center">
        <canvas id="networkCanvas" width="800" height="500"></canvas>
    </div>

    <!-- Legend Bar (ç§»è‡³ç•«å¸ƒä¸‹æ–¹ï¼Œé¿å…é®æ“‹) -->
    <div class="w-full max-w-4xl mt-3 bg-white p-3 rounded-lg border border-slate-200 text-xs flex flex-wrap items-center justify-center gap-x-6 gap-y-2 shadow-sm">
        <div class="flex items-center"><span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span> äº¤æ›å™¨ (Switch)</div>
        <div class="flex items-center"><span class="w-3 h-1 bg-gray-400 mr-2"></span> é€£æ¥ç·š (Link)</div>
        <div class="flex items-center"><span class="w-3 h-1 bg-orange-500 mr-2 border-b-2 border-orange-500 border-dashed"></span> STP é˜»æ–· (Blocking)</div>
        <div class="flex items-center">
            <span class="w-4 h-4 bg-[#d946ef] rounded-full mr-2 border-2 border-white shadow flex items-center justify-center text-[8px] text-white font-bold">B</span> 
            å»£æ’­å°åŒ… (Broadcast)
        </div>
        <div class="text-gray-500 italic border-l pl-4 ml-2 border-gray-300">
            * STP é—œé–‰æ™‚ï¼Œè£ç½®å›æ‡‰å¯èƒ½å°è‡´å°åŒ…å¢ç”Ÿ
        </div>
    </div>

    <!-- Controls -->
    <div class="control-panel w-full max-w-4xl mt-4 p-4 rounded-xl shadow-lg border border-slate-200 flex flex-col md:flex-row gap-4 justify-between items-center">
        
        <div class="flex flex-wrap gap-2 justify-center md:justify-start">
            <button onclick="toggleSTP()" id="btn-stp" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 font-bold transition whitespace-nowrap">
                STP: é—œé–‰ (OFF)
            </button>
            <div class="hidden md:block h-10 w-px bg-gray-300 mx-2"></div>
            <button onclick="sendBroadcast()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold shadow transition flex items-center gap-2 whitespace-nowrap">
                <span>ğŸ“¡ ç™¼é€å»£æ’­å°åŒ…</span>
            </button>
            <button onclick="resetSim()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 font-bold shadow transition whitespace-nowrap">
                é‡ç½®æ¨¡æ“¬
            </button>
        </div>

        <div class="text-sm text-gray-700 bg-blue-50 px-3 py-2 rounded border border-blue-100 w-full md:w-auto md:max-w-md text-center md:text-left">
            <span id="status-text">ç›®å‰ç‹€æ…‹ï¼šç’°è·¯å­˜åœ¨ã€‚è«‹å˜—è©¦ç™¼é€å»£æ’­å°åŒ…è§€å¯Ÿé¢¨æš´ã€‚</span>
        </div>
    </div>

    <!-- Footer -->
    <div class="w-full text-center mt-8 mb-4 text-[10px] text-gray-400 font-light">
        Planning & Design by Timmy(timmyc@hauman.com.tw) | è±ªå‹‰ç§‘æŠ€ Hauman Technologies Corporation | Ver 1.0
    </div>

    <script>
        // --- è¨­å®š ---
        const canvas = document.getElementById('networkCanvas');
        const ctx = canvas.getContext('2d');
        const packetCountEl = document.getElementById('packet-count');
        const stormWarningEl = document.getElementById('storm-warning');
        const statusText = document.getElementById('status-text');
        const btnStp = document.getElementById('btn-stp');

        // --- ç‹€æ…‹è®Šæ•¸ ---
        let isSTPEnabled = false;
        let packets = [];
        let time = 0;
        let packetIdCounter = 0;
        const SPEED = 2.0; 
        const MAX_PACKETS = 200; // ä¸Šé™è¨­ç‚º 200

        // --- ç¶²è·¯æ‹“æ¨¸å®šç¾© ---
        const switches = [
            { id: 0, x: 400, y: 100, name: "Switch A (Root)", isRoot: true },
            { id: 1, x: 200, y: 400, name: "Switch B", isRoot: false },
            { id: 2, x: 600, y: 400, name: "Switch C", isRoot: false }
        ];

        let links = [
            { s: 0, t: 1, blocked: false }, // A-B
            { s: 0, t: 2, blocked: false }, // A-C
            { s: 1, t: 2, blocked: false }  // B-C (Loop!)
        ];

        // --- é¡åˆ¥èˆ‡å‡½æ•¸ ---

        class Packet {
            constructor(startNodeId, endNodeId, fromNodeId) {
                this.id = packetIdCounter++;
                this.startNode = switches[startNodeId];
                this.endNode = switches[endNodeId];
                this.fromNodeId = fromNodeId; 
                this.progress = 0;
                this.finished = false;
            }

            update() {
                this.progress += 0.01 * SPEED;
                if (this.progress >= 1) {
                    this.progress = 1;
                    this.finished = true;
                }
            }

            draw() {
                const sx = this.startNode.x;
                const sy = this.startNode.y;
                const ex = this.endNode.x;
                const ey = this.endNode.y;

                const cx = sx + (ex - sx) * this.progress;
                const cy = sy + (ey - sy) * this.progress;

                ctx.shadowBlur = 10;
                ctx.shadowColor = 'rgba(217, 70, 239, 0.6)'; 

                ctx.beginPath();
                ctx.arc(cx, cy, 9, 0, Math.PI * 2); 
                ctx.fillStyle = '#d946ef'; 
                ctx.fill();
                
                ctx.shadowBlur = 0;
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();

                ctx.fillStyle = '#fff';
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('B', cx, cy);
            }
        }

        // --- æ ¸å¿ƒé‚è¼¯ ---

        function toggleSTP() {
            isSTPEnabled = !isSTPEnabled;
            updateLinkState();
            updateUI();
        }

        function updateLinkState() {
            if (isSTPEnabled) {
                links[0].blocked = false;
                links[1].blocked = false;
                links[2].blocked = true; // Block B-C link
            } else {
                links.forEach(l => l.blocked = false);
            }
        }

        function sendBroadcast() {
            if (packets.length > 20) return; 

            statusText.innerText = "Switch A ç™¼é€å»£æ’­è«‹æ±‚...";
            statusText.className = "text-sm text-blue-700 bg-blue-50 px-3 py-2 rounded border border-blue-100 max-w-md w-full md:w-auto";

            spawnPacketsFromNode(0, -1);
        }

        function spawnPacketsFromNode(nodeId, fromId) {
            links.forEach(link => {
                if (link.blocked) return;

                let targetId = -1;
                if (link.s === nodeId) targetId = link.t;
                if (link.t === nodeId) targetId = link.s;

                if (targetId !== -1 && targetId !== fromId) {
                    if (packets.length < MAX_PACKETS) {
                        packets.push(new Packet(nodeId, targetId, nodeId));
                    }
                }
            });
        }

        function handlePacketArrival(packet) {
            const receiverId = packet.endNode.id;
            
            // 1. æ­£å¸¸è½‰ç™¼ (Flooding)
            spawnPacketsFromNode(receiverId, packet.fromNodeId);

            // 2. æ¨¡æ“¬é¢¨æš´å¢ç”Ÿæ•ˆæ‡‰ (Simulation of Storm Amplification)
            if (!isSTPEnabled && packets.length < MAX_PACKETS) {
                if (Math.random() < 0.20) {
                    setTimeout(() => {
                        if (!isSTPEnabled && packets.length < MAX_PACKETS) {
                            spawnPacketsFromNode(receiverId, -1); 
                        }
                    }, 100);
                }
            }
        }

        function resetSim() {
            packets = [];
            stormWarningEl.classList.add('hidden');
            packetCountEl.classList.remove('text-red-600');
            packetCountEl.classList.add('text-green-600');
            statusText.innerText = isSTPEnabled ? "ç‹€æ…‹ï¼šSTP å·²é–‹å•Ÿã€‚ç’°è·¯å·²é˜»æ–·ã€‚" : "ç‹€æ…‹ï¼šç’°è·¯å­˜åœ¨ã€‚è«‹å°å¿ƒå»£æ’­é¢¨æš´ã€‚";
        }

        function updateUI() {
            if (isSTPEnabled) {
                btnStp.innerText = "STP: é–‹å•Ÿ (ON)";
                btnStp.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                btnStp.classList.add('bg-green-500', 'text-white', 'hover:bg-green-600');
                statusText.innerText = "STP å·²å•Ÿå‹•ã€‚Switch B èˆ‡ C ä¹‹é–“çš„é€£ç·šè¢«é‚è¼¯é˜»æ–· (Blocking)ï¼Œé˜²æ­¢è¿´åœˆã€‚";
            } else {
                btnStp.innerText = "STP: é—œé–‰ (OFF)";
                btnStp.classList.remove('bg-green-500', 'text-white', 'hover:bg-green-600');
                btnStp.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                statusText.innerText = "STP å·²é—œé–‰ã€‚æ‰€æœ‰é€£ç·šæš¢é€šï¼Œå½¢æˆäº†ç‰©ç†è¿´åœˆ (Loop)ã€‚";
            }
            packetCountEl.innerText = packets.length;
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ç¹ªè£½é€£ç·š
            ctx.lineWidth = 4;
            links.forEach(link => {
                const sNode = switches[link.s];
                const tNode = switches[link.t];

                ctx.beginPath();
                ctx.moveTo(sNode.x, sNode.y);
                ctx.lineTo(tNode.x, tNode.y);

                if (link.blocked) {
                    ctx.strokeStyle = '#f97316';
                    ctx.setLineDash([10, 10]); 
                } else {
                    ctx.strokeStyle = '#94a3b8'; 
                    ctx.setLineDash([]);
                }
                ctx.stroke();

                if (link.blocked) {
                    const midX = (sNode.x + tNode.x) / 2;
                    const midY = (sNode.y + tNode.y) / 2;
                    ctx.fillStyle = '#f97316';
                    ctx.font = 'bold 20px Arial';
                    ctx.fillText('âœ•', midX - 8, midY + 8);
                    ctx.font = '12px Noto Sans TC';
                    ctx.fillText('Blocked', midX - 20, midY + 25);
                }
            });
            ctx.setLineDash([]);

            // ç¹ªè£½äº¤æ›å™¨
            switches.forEach(sw => {
                ctx.beginPath();
                ctx.arc(sw.x, sw.y + 4, 30, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(0,0,0,0.1)';
                ctx.fill();

                ctx.beginPath();
                ctx.arc(sw.x, sw.y, 30, 0, Math.PI * 2);
                ctx.fillStyle = sw.isRoot ? '#2563eb' : '#3b82f6';
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 3;
                ctx.stroke();

                ctx.fillStyle = '#fff';
                ctx.font = '24px Arial';
                ctx.fillText('â‡‹', sw.x - 12, sw.y + 8);

                ctx.fillStyle = '#1e293b';
                ctx.font = 'bold 14px Noto Sans TC';
                ctx.textAlign = 'center';
                ctx.fillText(sw.name, sw.x, sw.y - 45);
                
                if (sw.isRoot && isSTPEnabled) {
                    ctx.fillStyle = '#f59e0b';
                    ctx.font = '12px Noto Sans TC';
                    ctx.fillText('ğŸ‘‘ Root Bridge', sw.x, sw.y + 55);
                }
            });

            // ç¹ªè£½å°åŒ…
            for (let i = packets.length - 1; i >= 0; i--) {
                let p = packets[i];
                p.update();
                p.draw();

                if (p.finished) {
                    handlePacketArrival(p);
                    packets.splice(i, 1);
                }
            }

            // UI æ›´æ–°èˆ‡é¢¨æš´è­¦å‘Š
            packetCountEl.innerText = packets.length;
            
            if (packets.length > 50) {
                stormWarningEl.classList.remove('hidden');
                packetCountEl.classList.remove('text-green-600');
                packetCountEl.classList.add('text-red-600');
                if (!isSTPEnabled) {
                     statusText.innerHTML = "<span class='text-red-600 font-bold'>å»£æ’­é¢¨æš´ç™¼ç”Ÿä¸­ï¼</span> ç¶²è·¯å› å°åŒ…éå¤šè€Œç™±ç˜“ã€‚";
                }
            } else {
                stormWarningEl.classList.add('hidden');
                packetCountEl.classList.remove('text-red-600');
                packetCountEl.classList.add('text-green-600');
            }

            requestAnimationFrame(draw);
        }

        updateLinkState();
        draw();

    </script>
</body>
</html>